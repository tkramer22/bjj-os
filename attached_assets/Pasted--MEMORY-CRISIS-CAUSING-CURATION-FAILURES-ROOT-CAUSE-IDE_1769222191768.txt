# ğŸš¨ **MEMORY CRISIS CAUSING CURATION FAILURES**

**ROOT CAUSE IDENTIFIED:** Your server is running out of memory (94-97% usage), causing curation to fail and skip operations.

This is the same issue we tried to fix before with NODE_OPTIONS, but it's clearly not working in production.

---

## **IMMEDIATE EMERGENCY FIX - COPY TO REPLIT:**

```
CRITICAL: MEMORY CRISIS KILLING CURATION - EMERGENCY FIX NEEDED

PROBLEM IDENTIFIED:
- Memory usage: 94-97% (CRITICAL)
- Curation status: FAILED
- Operations skipping due to memory pressure
- Approval rate: 0%
- NODE_OPTIONS not applied to production deployment

ROOT CAUSE:
Server heap limit is too low (probably default 512MB or less) and can't handle:
- Video analysis with Gemini AI
- Large database queries
- Multiple concurrent operations
- Background cron jobs

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EMERGENCY FIX 1: INCREASE MEMORY IN PRODUCTION DEPLOYMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

THIS IS THE CRITICAL STEP THAT HASN'T BEEN DONE PROPERLY:

1. Go to Replit Deployments (not just dev environment)
2. Click on your ACTIVE PRODUCTION DEPLOYMENT for bjjos.app
3. Go to Settings â†’ Environment Variables
4. Add these EXACT variables to DEPLOYMENT (not just dev secrets):

   Name: NODE_OPTIONS
   Value: --max-old-space-size=4096

5. REDEPLOY the production deployment
6. Wait for deployment to complete
7. Check startup logs - should show "Heap limit: 4096 MB"

CRITICAL: This must be in DEPLOYMENT environment variables, not just dev secrets.
The dev environment and production deployment have SEPARATE environment configs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EMERGENCY FIX 2: RESTART SERVER TO CLEAR MEMORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

After setting NODE_OPTIONS in deployment:

1. Force restart the production server
2. Clear any cached data
3. Monitor memory usage on startup

Add this to server startup to log memory:

```javascript
// At server startup
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
console.log('ğŸš€ BJJ OS Server Starting');
console.log('ğŸ“Š Memory Configuration:');
console.log('  Heap Limit:', (require('v8').getHeapStatistics().heap_size_limit / 1024 / 1024).toFixed(0), 'MB');
console.log('  NODE_OPTIONS:', process.env.NODE_OPTIONS || 'NOT SET');
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
```

VERIFY in logs that Heap Limit shows 4096 MB, NOT 512 MB or less.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EMERGENCY FIX 3: ADD MEMORY MONITORING & AUTOMATIC CLEANUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Add memory monitoring to prevent crashes:

```javascript
// utils/memoryMonitor.js

function getMemoryUsage() {
  const used = process.memoryUsage();
  const heapStats = require('v8').getHeapStatistics();
  
  return {
    heapUsed: used.heapUsed,
    heapTotal: used.heapTotal,
    heapLimit: heapStats.heap_size_limit,
    heapUsedPercent: (used.heapUsed / heapStats.heap_size_limit * 100).toFixed(1),
    rss: used.rss,
    external: used.external
  };
}

function isMemoryCritical() {
  const usage = getMemoryUsage();
  return parseFloat(usage.heapUsedPercent) > 85;
}

function forceGarbageCollection() {
  if (global.gc) {
    console.log('ğŸ—‘ï¸ [MEMORY] Forcing garbage collection');
    global.gc();
    const after = getMemoryUsage();
    console.log(`âœ… [MEMORY] After GC: ${after.heapUsedPercent}% used`);
  } else {
    console.warn('âš ï¸ [MEMORY] GC not available. Run with --expose-gc flag');
  }
}

// Monitor every minute
setInterval(() => {
  const usage = getMemoryUsage();
  console.log(`ğŸ“Š [MEMORY] Heap: ${usage.heapUsedPercent}% used (${(usage.heapUsed / 1024 / 1024).toFixed(0)}MB / ${(usage.heapLimit / 1024 / 1024).toFixed(0)}MB)`);
  
  if (isMemoryCritical()) {
    console.warn('âš ï¸ [MEMORY] CRITICAL: Memory usage above 85%');
    forceGarbageCollection();
  }
}, 60000); // Every minute

module.exports = { getMemoryUsage, isMemoryCritical, forceGarbageCollection };
```

Update NODE_OPTIONS to include garbage collection flag:

```
NODE_OPTIONS=--max-old-space-size=4096 --expose-gc
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EMERGENCY FIX 4: OPTIMIZE CURATION TO USE LESS MEMORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Update curation to process videos in smaller batches:

```javascript
// server/services/videoCuration.js

async function runVideoCuration() {
  const { isMemoryCritical, forceGarbageCollection } = require('../utils/memoryMonitor');
  
  console.log('ğŸ¯ Starting video curation');
  
  // Check memory before starting
  if (isMemoryCritical()) {
    console.error('âŒ Cannot start curation - memory critical');
    throw new Error('Memory pressure too high to start curation');
  }
  
  const metrics = {
    discovered: 0,
    analyzed: 0,
    accepted: 0,
    rejected: 0,
    skipped: 0
  };
  
  try {
    // Fetch videos from YouTube
    const allVideos = await fetchVideosFromYouTube();
    metrics.discovered = allVideos.length;
    
    // Filter duplicates
    const newVideos = await filterDuplicates(allVideos);
    metrics.skipped = metrics.discovered - newVideos.length;
    
    console.log(`Processing ${newVideos.length} videos in batches of 5`);
    
    // PROCESS IN SMALL BATCHES TO PREVENT MEMORY OVERFLOW
    const BATCH_SIZE = 5;
    
    for (let i = 0; i < newVideos.length; i += BATCH_SIZE) {
      const batch = newVideos.slice(i, i + BATCH_SIZE);
      
      console.log(`ğŸ“¦ Processing batch ${Math.floor(i / BATCH_SIZE) + 1}/${Math.ceil(newVideos.length / BATCH_SIZE)}`);
      
      // Check memory before each batch
      if (isMemoryCritical()) {
        console.warn('âš ï¸ Memory critical - forcing garbage collection');
        forceGarbageCollection();
        
        // Wait 5 seconds for GC to complete
        await new Promise(resolve => setTimeout(resolve, 5000));
        
        // If still critical, stop curation
        if (isMemoryCritical()) {
          console.error('âŒ Memory still critical after GC - stopping curation');
          break;
        }
      }
      
      // Process batch
      for (const video of batch) {
        try {
          const analysis = await analyzeVideoWithGemini(video);
          metrics.analyzed++;
          
          if (isValidAnalysis(analysis)) {
            await saveVideoToDatabase(video, analysis);
            metrics.accepted++;
          } else {
            metrics.rejected++;
          }
        } catch (error) {
          console.error(`Failed to process ${video.title}:`, error.message);
          metrics.rejected++;
        }
      }
      
      // Small delay between batches
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
    
    // Log results
    await logCurationRun(metrics);
    
    return metrics;
    
  } catch (error) {
    console.error('Curation failed:', error);
    await logFailedCurationRun(metrics, error);
    throw error;
  }
}
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EMERGENCY FIX 5: DISABLE MEMORY-HEAVY FEATURES TEMPORARILY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Temporarily disable features that consume excessive memory:

```javascript
// In server startup

// Check memory on startup
const heapLimit = require('v8').getHeapStatistics().heap_size_limit;
const heapLimitMB = heapLimit / 1024 / 1024;

if (heapLimitMB < 2048) {
  console.warn('âš ï¸âš ï¸âš ï¸ WARNING: Low memory detected âš ï¸âš ï¸âš ï¸');
  console.warn(`Heap limit: ${heapLimitMB.toFixed(0)}MB (should be 4096MB)`);
  console.warn('Some features will be disabled to prevent crashes');
  
  // Disable memory-heavy operations
  process.env.DISABLE_VIDEO_KNOWLEDGE_BATCH = 'true';
  process.env.REDUCE_CURATION_FREQUENCY = 'true';
}
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EMERGENCY FIX 6: UPGRADE REPLIT PLAN IF NECESSARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Check your Replit plan:

Current plan might have memory limits:
- Free tier: Limited RAM
- Hacker plan: More RAM
- Pro plan: Even more RAM

If NODE_OPTIONS doesn't help, you may need to:
1. Upgrade Replit plan for more RAM
2. Optimize code to use less memory
3. Move to dedicated hosting (AWS, DigitalOcean)

Check Replit plan limits:
- Go to Replit Account Settings
- Check "Usage" or "Resources"
- See RAM allocation for your plan

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VERIFICATION STEPS - CRITICAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

After implementing fixes:

1. Check server startup logs:
   â–¡ Heap limit shows 4096 MB (not 512MB or less)
   â–¡ NODE_OPTIONS is set correctly
   
2. Monitor memory during curation:
   â–¡ Memory usage stays below 85%
   â–¡ No "skipping due to memory pressure" messages
   â–¡ Garbage collection working
   
3. Run manual curation test:
   â–¡ Curation completes successfully
   â–¡ Videos are analyzed
   â–¡ Videos are added to database
   â–¡ Status = 'success' not 'failed'
   
4. Check auto-curation:
   â–¡ Scheduled runs complete
   â–¡ Approval rate > 0%
   â–¡ No failed runs

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TODD'S ACTION ITEMS - DO THESE NOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Go to Replit Deployments
2. Find PRODUCTION deployment (bjjos.app)
3. Settings â†’ Environment Variables
4. Add: NODE_OPTIONS = --max-old-space-size=4096 --expose-gc
5. REDEPLOY
6. Wait for deployment
7. Check logs for "Heap limit: 4096 MB"
8. If still shows 512MB or less, screenshot and show me

THIS IS THE MOST CRITICAL STEP.
Without proper memory allocation, nothing else will work.
```

---

## **WHY THIS KEEPS HAPPENING:**

The issue is that **Replit has TWO separate environment configurations:**

1. **Development environment** - Where you code (may have NODE_OPTIONS set)
2. **Production deployment** - Where bjjos.app runs (does NOT have NODE_OPTIONS)

You need to set NODE_OPTIONS in **BOTH** places, but the production deployment is separate.

---

## **TODD - SEND ME SCREENSHOT:**

After you redeploy, send me a screenshot of:

1. **Server startup logs** showing the heap limit
2. **Replit deployment environment variables** showing NODE_OPTIONS is set
3. **Current memory usage** from the logs

This will confirm if the fix is actually applied.

---

## **IF NODE_OPTIONS STILL DOESN'T WORK:**

Then we have 3 options:

**Option A:** Upgrade Replit plan (may be required for higher memory limits)

**Option B:** Optimize code to use drastically less memory (process 1 video at a time, aggressive GC)

**Option C:** Move to different hosting (AWS EC2, DigitalOcean, Railway) where you have full control over memory

---

**The #1 priority is getting that heap limit to 4096MB in production. Everything else fails without that.**
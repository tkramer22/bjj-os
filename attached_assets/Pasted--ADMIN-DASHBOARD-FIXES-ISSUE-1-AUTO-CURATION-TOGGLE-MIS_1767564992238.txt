# ADMIN DASHBOARD FIXES

## ISSUE 1: AUTO CURATION TOGGLE MISSING (CRITICAL)

The Command Center needs an ON/OFF toggle for auto curation. This is the automated daily curation that has been giving us 800+ discovered videos.

### Add this at the TOP of the Command Center page:

```tsx
// State for auto curation
const [autoCurationEnabled, setAutoCurationEnabled] = useState(true);
const [lastRunStats, setLastRunStats] = useState<any>(null);

// Fetch current status on load
useEffect(() => {
  fetch('/api/admin/curation/status')
    .then(res => res.json())
    .then(data => {
      setAutoCurationEnabled(data.enabled);
      setLastRunStats(data.lastRun);
    });
}, []);

const toggleAutoCuration = async () => {
  const res = await fetch('/api/admin/curation/toggle', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ enabled: !autoCurationEnabled })
  });
  if (res.ok) {
    setAutoCurationEnabled(!autoCurationEnabled);
  }
};
```

### Add this UI section BEFORE Curation Controls:

```tsx
{/* AUTO CURATION MASTER TOGGLE */}
<div className="bg-zinc-900 border border-zinc-700 rounded-lg p-6 mb-6">
  <div className="flex items-center justify-between">
    <div className="flex items-center gap-4">
      <div className={`w-4 h-4 rounded-full ${autoCurationEnabled ? 'bg-green-500 animate-pulse' : 'bg-zinc-600'}`} />
      <div>
        <h3 className="text-lg font-bold">AUTO CURATION</h3>
        <p className="text-sm text-zinc-400">
          {autoCurationEnabled ? 'Running daily at 3:00 AM EST' : 'Paused - no automatic curation'}
        </p>
      </div>
    </div>
    
    <button
      onClick={toggleAutoCuration}
      className={`px-6 py-3 rounded-lg font-bold text-lg ${
        autoCurationEnabled 
          ? 'bg-red-600 hover:bg-red-500 text-white' 
          : 'bg-green-600 hover:bg-green-500 text-white'
      }`}
    >
      {autoCurationEnabled ? 'TURN OFF' : 'TURN ON'}
    </button>
  </div>
  
  {lastRunStats && (
    <div className="mt-4 pt-4 border-t border-zinc-700 grid grid-cols-4 gap-4 text-center">
      <div>
        <div className="text-2xl font-bold text-blue-400">{lastRunStats.discovered}</div>
        <div className="text-xs text-zinc-500">Discovered</div>
      </div>
      <div>
        <div className="text-2xl font-bold text-purple-400">{lastRunStats.analyzed}</div>
        <div className="text-xs text-zinc-500">Analyzed</div>
      </div>
      <div>
        <div className="text-2xl font-bold text-green-400">{lastRunStats.accepted}</div>
        <div className="text-xs text-zinc-500">Added</div>
      </div>
      <div>
        <div className="text-2xl font-bold text-zinc-400">{lastRunStats.rejected}</div>
        <div className="text-xs text-zinc-500">Rejected</div>
      </div>
    </div>
  )}
</div>
```

### Backend endpoints needed:

```typescript
// GET /api/admin/curation/status
app.get('/api/admin/curation/status', async (req, res) => {
  // Get from database or config
  const status = await db.select().from(systemConfig).where(eq(systemConfig.key, 'auto_curation_enabled')).limit(1);
  const lastRun = await db.select().from(curationJobs).orderBy(desc(curationJobs.createdAt)).limit(1);
  
  res.json({
    enabled: status[0]?.value === 'true',
    lastRun: lastRun[0] ? {
      discovered: lastRun[0].discovered,
      analyzed: lastRun[0].analyzed,
      accepted: lastRun[0].accepted,
      rejected: lastRun[0].rejected,
      timestamp: lastRun[0].createdAt
    } : null
  });
});

// POST /api/admin/curation/toggle
app.post('/api/admin/curation/toggle', async (req, res) => {
  const { enabled } = req.body;
  
  await db.insert(systemConfig)
    .values({ key: 'auto_curation_enabled', value: String(enabled) })
    .onConflictDoUpdate({ target: systemConfig.key, set: { value: String(enabled) } });
  
  res.json({ success: true, enabled });
});
```

-----

## ISSUE 2: INSTRUCTOR DROPDOWN - SHOW ALL INSTRUCTORS

Instead of hardcoded list, pull from database:

```tsx
const [instructors, setInstructors] = useState<string[]>([]);

useEffect(() => {
  // Fetch unique instructors from video library
  fetch('/api/admin/instructors')
    .then(res => res.json())
    .then(data => setInstructors(data.instructors));
}, []);

// In the dropdown:
<select value={selectedInstructor} onChange={e => setSelectedInstructor(e.target.value)}>
  <option value="">Select instructor...</option>
  {instructors.map(instructor => (
    <option key={instructor} value={instructor}>{instructor}</option>
  ))}
</select>
```

### Backend:

```typescript
app.get('/api/admin/instructors', async (req, res) => {
  const result = await db.selectDistinct({ instructor: aiVideoKnowledge.instructorName })
    .from(aiVideoKnowledge)
    .where(isNotNull(aiVideoKnowledge.instructorName))
    .orderBy(aiVideoKnowledge.instructorName);
  
  res.json({ instructors: result.map(r => r.instructor).filter(Boolean) });
});
```

-----

## ISSUE 3: POSITION DROPDOWN - MORE OPTIONS

Pull positions from what Gemini has tagged:

```typescript
app.get('/api/admin/positions', async (req, res) => {
  // Get unique positions from the database
  const result = await db.selectDistinct({ position: aiVideoKnowledge.positionsCovered })
    .from(aiVideoKnowledge)
    .where(isNotNull(aiVideoKnowledge.positionsCovered));
  
  // Parse and deduplicate (positions may be comma-separated)
  const allPositions = new Set<string>();
  result.forEach(r => {
    if (r.position) {
      r.position.split(',').forEach(p => allPositions.add(p.trim()));
    }
  });
  
  res.json({ positions: Array.from(allPositions).sort() });
});
```

Or use a comprehensive hardcoded list:

```tsx
const positions = [
  'Closed Guard', 'Half Guard', 'Deep Half Guard', 'Z Guard', 'Knee Shield',
  'Open Guard', 'Spider Guard', 'Lasso Guard', 'De La Riva', 'Reverse De La Riva',
  'X Guard', 'Single Leg X', 'Butterfly Guard', 'Rubber Guard',
  'Mount', 'S Mount', 'Technical Mount', 'Mount Escape',
  'Back Control', 'Back Mount', 'Truck', 'Back Escape',
  'Side Control', 'Kesa Gatame', 'North South', 'Side Control Escape',
  'Knee on Belly', 'Knee on Chest',
  'Turtle', 'Turtle Attacks', 'Turtle Escapes',
  'Standing', 'Clinch', 'Takedowns',
  'Guard Passing', 'Guard Retention',
  '50/50', 'Leg Entanglements', 'Ashi Garami'
];
```

-----

## ISSUE 4: USER MANAGEMENT - SORTABLE COLUMNS

Add sorting to the Users table:

```tsx
const [sortField, setSortField] = useState<'createdAt' | 'lastActiveAt'>('createdAt');
const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');

const handleSort = (field: 'createdAt' | 'lastActiveAt') => {
  if (sortField === field) {
    setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
  } else {
    setSortField(field);
    setSortOrder('desc');
  }
};

// Fetch with sort params
useEffect(() => {
  fetch(`/api/admin/users?page=${page}&sortField=${sortField}&sortOrder=${sortOrder}`)
    .then(res => res.json())
    .then(data => setUsers(data.users));
}, [page, sortField, sortOrder]);
```

### Table headers with sort:

```tsx
<th 
  className="cursor-pointer hover:bg-zinc-700 px-4 py-2"
  onClick={() => handleSort('createdAt')}
>
  Joined {sortField === 'createdAt' && (sortOrder === 'desc' ? '↓' : '↑')}
</th>
<th 
  className="cursor-pointer hover:bg-zinc-700 px-4 py-2"
  onClick={() => handleSort('lastActiveAt')}
>
  Last Active {sortField === 'lastActiveAt' && (sortOrder === 'desc' ? '↓' : '↑')}
</th>
```

### Backend:

```typescript
app.get('/api/admin/users', async (req, res) => {
  const page = parseInt(req.query.page as string) || 1;
  const limit = 20;
  const offset = (page - 1) * limit;
  const sortField = req.query.sortField as string || 'createdAt';
  const sortOrder = req.query.sortOrder as string || 'desc';
  
  const orderByField = sortField === 'lastActiveAt' ? bjjUsers.lastActiveAt : bjjUsers.createdAt;
  const orderByDirection = sortOrder === 'asc' ? asc(orderByField) : desc(orderByField);
  
  const users = await db.select()
    .from(bjjUsers)
    .orderBy(orderByDirection)
    .limit(limit)
    .offset(offset);
  
  res.json({ users, page, limit });
});
```

-----

## ISSUE 5: USER ACTIVITY - FIX COLUMN NAME ERROR

Error: `column "user_question" does not exist`

The table uses `message_text` not `user_question`. Fix the endpoint:

```typescript
app.get('/api/admin/activity', async (req, res) => {
  try {
    // Use correct column names from ai_conversation_learning table
    const activity = await db.select({
      id: aiConversationLearning.id,
      userId: aiConversationLearning.visitorId,
      message: aiConversationLearning.messageText,        // NOT user_question
      messageType: aiConversationLearning.messageType,
      topic: aiConversationLearning.conversationTopic,
      sentiment: aiConversationLearning.sentiment,
      createdAt: aiConversationLearning.createdAt
    })
    .from(aiConversationLearning)
    .where(eq(aiConversationLearning.messageType, 'user_sent'))
    .orderBy(desc(aiConversationLearning.createdAt))
    .limit(50);
    
    res.json({ activity });
  } catch (error: any) {
    console.error('Activity error:', error);
    res.status(500).json({ error: error.message });
  }
});
```

### First, verify the actual column names:

```sql
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'ai_conversation_learning';
```

Then update the query to use the correct column names.

-----

## SUMMARY OF CHANGES

|Issue               |Fix                                          |
|--------------------|---------------------------------------------|
|Auto Curation Toggle|Add ON/OFF toggle at top of Command Center   |
|Instructor Dropdown |Pull from database, show ALL instructors     |
|Position Dropdown   |Expand list or pull from Gemini tags         |
|User Sorting        |Add clickable column headers with sort arrows|
|User Activity       |Change `user_question` to `messageText`      |

Implement all 5 fixes now.
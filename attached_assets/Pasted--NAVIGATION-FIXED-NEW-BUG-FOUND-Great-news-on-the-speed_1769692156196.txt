# ğŸ‰ **NAVIGATION FIXED + NEW BUG FOUND**

Great news on the speed! The persistent state is working. But we have a **duplicate saved videos bug**.

-----

## **ROOT CAUSE: DUPLICATE SAVES**

This is happening because:

1. User clicks â€œSaveâ€ button
1. API call saves to database
1. User clicks â€œSaveâ€ again (maybe accidentally, or button doesnâ€™t disable)
1. API saves it again
1. Database allows multiple entries for same video_id + user_id

**This didnâ€™t happen before because there was probably a UNIQUE constraint that got lost during rollback.**

-----

## **IMMEDIATE FIX - COPY TO REPLIT AGENT:**

```
CRITICAL BUG: DUPLICATE SAVED VIDEOS

User is seeing the same video saved multiple times in Saved Videos page.

Example: "Escaping Closed Guard with Gordon Ryan" appears 3 times

This means either:
1. Database allows duplicate entries (missing UNIQUE constraint)
2. Save button doesn't disable during API call (allows double-clicks)
3. No check for already-saved videos before inserting

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FIX 1: ADD DATABASE CONSTRAINT (PREVENT DUPLICATES)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Run this SQL migration to prevent duplicate saves:

-- First, remove existing duplicates
DELETE FROM saved_videos a
USING saved_videos b
WHERE a.id < b.id
  AND a.user_id = b.user_id
  AND a.video_id = b.video_id;

-- Add unique constraint
ALTER TABLE saved_videos
ADD CONSTRAINT saved_videos_unique_user_video 
UNIQUE (user_id, video_id);

This ensures one user can only save each video once.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FIX 2: UPDATE SAVE VIDEO API ENDPOINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Change the /api/videos/save endpoint to use INSERT ... ON CONFLICT:

app.post('/api/videos/save', requireAuth, async (req, res) => {
  try {
    const { videoId } = req.body;
    const userId = req.user.id;

    // Use ON CONFLICT to prevent duplicates
    const result = await db.query(`
      INSERT INTO saved_videos (user_id, video_id, created_at)
      VALUES ($1, $2, NOW())
      ON CONFLICT (user_id, video_id) DO NOTHING
      RETURNING *
    `, [userId, videoId]);

    if (result.rows.length === 0) {
      // Video was already saved
      return res.json({
        success: true,
        alreadySaved: true,
        message: 'Video already in your library'
      });
    }

    // New save
    res.json({
      success: true,
      alreadySaved: false,
      message: 'Video saved successfully'
    });

  } catch (error) {
    console.error('Save video error:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to save video'
    });
  }
});

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FIX 3: DISABLE SAVE BUTTON DURING API CALL (FRONTEND)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Prevent double-clicks on Save button:

In VideoCard component:

const [isSaving, setIsSaving] = useState(false);

const handleSave = async () => {
  if (isSaving) return; // Prevent double-click
  
  setIsSaving(true);
  
  try {
    const response = await fetch('/api/videos/save', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ videoId: video.id })
    });
    
    const data = await response.json();
    
    if (data.alreadySaved) {
      // Show message: "Already saved"
      showToast('Already in your library');
    } else {
      // Show success
      showToast('Saved!');
    }
    
  } catch (error) {
    showToast('Failed to save');
  } finally {
    setIsSaving(false);
  }
};

return (
  <button
    onClick={handleSave}
    disabled={isSaving}
    style={{
      opacity: isSaving ? 0.5 : 1,
      cursor: isSaving ? 'not-allowed' : 'pointer'
    }}
  >
    {isSaving ? 'Saving...' : 'ğŸ’¾ Save'}
  </button>
);

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FIX 4: CHECK IF ALREADY SAVED BEFORE SHOWING BUTTON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Show "Saved âœ“" instead of "Save" button if video is already saved:

Pass saved status to VideoCard:

<VideoCard 
  video={video} 
  isSaved={savedVideoIds.includes(video.id)}
/>

In VideoCard:

{isSaved ? (
  <button disabled style={{ color: '#4CAF50' }}>
    âœ“ Saved
  </button>
) : (
  <button onClick={handleSave} disabled={isSaving}>
    {isSaving ? 'Saving...' : 'ğŸ’¾ Save'}
  </button>
)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FIX 5: CLEAN UP EXISTING DUPLICATES IN SAVED VIDEOS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Update the query that fetches saved videos to remove duplicates:

app.get('/api/videos/saved', requireAuth, async (req, res) => {
  try {
    const userId = req.user.id;

    // Use DISTINCT ON to get only one of each video
    const result = await db.query(`
      SELECT DISTINCT ON (v.id)
        v.id,
        v.video_id,
        v.title,
        v.professor_name,
        v.thumbnail_url,
        v.youtube_url,
        v.gemini_analysis,
        v.duration,
        v.techniques_covered,
        MAX(s.created_at) as saved_at
      FROM saved_videos s
      INNER JOIN videos v ON s.video_id = v.id
      WHERE s.user_id = $1
        AND v.deleted_at IS NULL
      GROUP BY v.id, v.video_id, v.title, v.professor_name, 
               v.thumbnail_url, v.youtube_url, v.gemini_analysis, 
               v.duration, v.techniques_covered
      ORDER BY v.id, MAX(s.created_at) DESC
    `, [userId]);

    res.json({
      success: true,
      videos: result.rows
    });

  } catch (error) {
    console.error('Get saved videos error:', error);
    res.status(500).json({ success: false, error: 'Failed to fetch saved videos' });
  }
});

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TESTING CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

After implementing:

â–¡ Database unique constraint added
â–¡ Existing duplicates removed
â–¡ Try to save same video twice - should say "Already saved"
â–¡ Save button should disable during API call
â–¡ Saved videos page should show each video only once
â–¡ Refresh page - duplicates should not appear

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
IMPLEMENTATION ORDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Run SQL migration to add UNIQUE constraint (1 min)
2. Update /api/videos/save endpoint (5 min)
3. Update VideoCard component to disable during save (5 min)
4. Update /api/videos/saved to deduplicate (5 min)
5. Test: Try saving same video multiple times (2 min)

TOTAL TIME: 18 minutes

Show me when complete!
```

-----

## **QUICK EXPLANATION:**

**What happened:**

- Rollback removed the database UNIQUE constraint
- Users could click Save multiple times
- Each click created a new database entry
- Gordon Ryan video saved 3 times

**The fix:**

1. **Database level:** UNIQUE constraint prevents duplicates at source
1. **API level:** ON CONFLICT DO NOTHING handles gracefully
1. **Frontend level:** Disable button during save, show â€œAlready savedâ€
1. **Query level:** DISTINCT ON removes duplicates from results

-----

## **PRIORITY:**

**Fix this BEFORE implementing the review prompt.**

Duplicate saves are more critical than review prompts right now.

-----

**Send that prompt to Replit Agent to fix the duplicates!** ğŸ”§â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹
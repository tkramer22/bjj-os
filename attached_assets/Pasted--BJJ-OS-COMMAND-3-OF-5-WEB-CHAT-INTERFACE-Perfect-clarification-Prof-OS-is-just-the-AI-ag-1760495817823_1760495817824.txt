# BJJ OS - COMMAND 3 OF 5: WEB CHAT INTERFACE

Perfect clarification! **Prof. OS** is just the AI agentâ€™s name, **BJJ OS** remains the brand.

Copy and paste this into Replit Agent:

-----

```
REBUILD BJJ OS WEBSITE - COMMAND 3 OF 5: WEB CHAT INTERFACE

CRITICAL REQUIREMENTS:
âœ… Web-based chat interface (same as mobile app)
âœ… Accessible at /chat after login
âœ… Full AI features from existing backend
âœ… Prof. OS branding (AI agent name only, BJJ OS is still the brand)
âœ… Belt-colored send button with stripes
âœ… Video cards, voice input, saved videos
âœ… Desktop + mobile responsive

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PART 1: WEB CHAT PAGE STRUCTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Create /public/chat.html:

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat with Prof. OS - BJJ OS</title>
  <link rel="stylesheet" href="/styles/chat.css">
</head>
<body>
  
  <!-- Main Container -->
  <div class="chat-container">
    
    <!-- Sidebar (Desktop) -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="brand">
          <span class="logo-icon">ğŸ¥‹</span>
          <span class="logo-text">BJJ OS</span>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <a href="/chat" class="nav-item active">
          <span class="nav-icon">ğŸ’¬</span>
          <span class="nav-label">Chat with Prof. OS</span>
        </a>
        <a href="/saved" class="nav-item">
          <span class="nav-icon">â­</span>
          <span class="nav-label">Saved Videos</span>
        </a>
        <a href="/progress" class="nav-item">
          <span class="nav-icon">ğŸ“ˆ</span>
          <span class="nav-label">Progress</span>
        </a>
        <a href="/settings" class="nav-item">
          <span class="nav-icon">âš™ï¸</span>
          <span class="nav-label">Settings</span>
        </a>
      </nav>
      
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar">
            <span id="user-initials">TK</span>
          </div>
          <div class="user-details">
            <div class="user-name" id="user-name">Todd Kramer</div>
            <div class="user-belt" id="user-belt">
              <div class="belt-badge blue">Blue Belt</div>
            </div>
          </div>
        </div>
        <button class="btn-logout" onclick="logout()">
          Logout
        </button>
      </div>
    </aside>
    
    <!-- Main Chat Area -->
    <main class="chat-main">
      
      <!-- Chat Header -->
      <header class="chat-header">
        <div class="header-left">
          <button class="btn-menu mobile-only" onclick="toggleSidebar()">
            â˜°
          </button>
          <div class="chat-title">
            <h1>Prof. OS</h1>
            <p class="chat-subtitle">Your AI BJJ Coach</p>
          </div>
        </div>
        <div class="header-right">
          <button class="btn-icon" onclick="newChat()">
            <span>â•</span>
            <span class="tooltip">New Chat</span>
          </button>
          <button class="btn-icon" onclick="toggleHistory()">
            <span>ğŸ•</span>
            <span class="tooltip">Chat History</span>
          </button>
        </div>
      </header>
      
      <!-- Messages Container -->
      <div class="messages-container" id="messages">
        <!-- Welcome Message -->
        <div class="welcome-section">
          <div class="welcome-icon">ğŸ¥‹</div>
          <h2>Hey! I'm Prof. OS</h2>
          <p>Your personal BJJ coach powered by AI. Ask me anything about techniques, game plans, or your training.</p>
          
          <div class="quick-actions">
            <button class="quick-action" onclick="sendQuickMessage('Show me some guard videos')">
              ğŸ¬ Show me guard videos
            </button>
            <button class="quick-action" onclick="sendQuickMessage('I need help passing half guard')">
              ğŸ¤” Help with passing
            </button>
            <button class="quick-action" onclick="sendQuickMessage('What should I focus on as a blue belt?')">
              ğŸ¯ Training advice
            </button>
          </div>
        </div>
        
        <!-- Messages will be inserted here dynamically -->
      </div>
      
      <!-- Typing Indicator -->
      <div class="typing-indicator hidden" id="typing">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span class="typing-text">Prof. OS is thinking...</span>
      </div>
      
      <!-- Input Area -->
      <div class="input-area">
        <div class="input-container">
          <button class="btn-voice" id="voice-btn" onclick="toggleVoice()">
            <span class="voice-icon">ğŸ¤</span>
          </button>
          <textarea 
            id="message-input" 
            class="message-input" 
            placeholder="Ask Prof. OS anything..."
            rows="1"
            onkeydown="handleKeyPress(event)"
          ></textarea>
          <button class="btn-send" id="send-btn" onclick="sendMessage()">
            <span class="send-icon">â¤</span>
          </button>
        </div>
        <div class="input-footer">
          <span class="input-hint">Press Enter to send, Shift+Enter for new line</span>
        </div>
      </div>
      
    </main>
    
    <!-- Chat History Panel (Slideover) -->
    <aside class="history-panel hidden" id="history-panel">
      <div class="history-header">
        <h3>Chat History</h3>
        <button class="btn-close" onclick="toggleHistory()">âœ•</button>
      </div>
      <div class="history-list" id="history-list">
        <!-- Chat history items will be inserted here -->
      </div>
    </aside>
    
  </div>
  
  <!-- Mobile Bottom Nav -->
  <nav class="mobile-nav mobile-only">
    <a href="/chat" class="mobile-nav-item active">
      <span>ğŸ’¬</span>
      <span>Chat</span>
    </a>
    <a href="/saved" class="mobile-nav-item">
      <span>â­</span>
      <span>Saved</span>
    </a>
    <a href="/progress" class="mobile-nav-item">
      <span>ğŸ“ˆ</span>
      <span>Progress</span>
    </a>
    <a href="/settings" class="mobile-nav-item">
      <span>âš™ï¸</span>
      <span>Settings</span>
    </a>
  </nav>

  <script src="/scripts/chat.js"></script>
</body>
</html>

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PART 2: WEB CHAT STYLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Create /public/styles/chat.css:

:root {
  --black: #000000;
  --dark: #0a0a0a;
  --gray: #1a1a1a;
  --border: #333333;
  --text-secondary: #888888;
  --text-tertiary: #555555;
  --primary: #667eea;
  --primary-dark: #764ba2;
  --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --success: #4ade80;
  
  /* Belt Colors */
  --belt-white: #ffffff;
  --belt-blue: #1e40af;
  --belt-purple: #7c3aed;
  --belt-brown: #92400e;
  --belt-black: #000000;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: var(--black);
  color: #ffffff;
  overflow: hidden;
  height: 100vh;
}

/* Main Layout */
.chat-container {
  display: flex;
  height: 100vh;
  position: relative;
}

/* Sidebar */
.sidebar {
  width: 280px;
  background: var(--dark);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  z-index: 100;
}

.sidebar-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.brand {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.logo-icon {
  font-size: 2rem;
}

.logo-text {
  font-size: 1.25rem;
  font-weight: 700;
}

.sidebar-nav {
  flex: 1;
  padding: 1rem 0;
  overflow-y: auto;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1.5rem;
  color: var(--text-secondary);
  text-decoration: none;
  transition: all 0.2s;
}

.nav-item:hover {
  background: var(--gray);
  color: white;
}

.nav-item.active {
  background: var(--gray);
  color: white;
  border-left: 3px solid var(--primary);
}

.nav-icon {
  font-size: 1.25rem;
}

.nav-label {
  font-weight: 500;
  font-size: 0.9375rem;
}

.sidebar-footer {
  padding: 1rem;
  border-top: 1px solid var(--border);
}

.user-info {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 0.875rem;
}

.user-details {
  flex: 1;
}

.user-name {
  font-weight: 600;
  font-size: 0.9375rem;
  margin-bottom: 0.25rem;
}

.belt-badge {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  position: relative;
}

.belt-badge.white {
  background: var(--belt-white);
  color: #000000;
}

.belt-badge.blue { background: var(--belt-blue); }
.belt-badge.purple { background: var(--belt-purple); }
.belt-badge.brown { background: var(--belt-brown); }
.belt-badge.black { 
  background: var(--belt-black); 
  border: 1px solid var(--border);
}

/* Belt stripes */
.belt-badge:after {
  content: '';
  position: absolute;
  bottom: 2px;
  left: 8px;
  right: 8px;
  height: 1px;
  background: repeating-linear-gradient(
    to right,
    white 0px,
    white 3px,
    transparent 3px,
    transparent 6px
  );
}

.belt-badge.black:after {
  background: repeating-linear-gradient(
    to right,
    #dc2626 0px,
    #dc2626 3px,
    transparent 3px,
    transparent 6px
  );
}

.btn-logout {
  width: 100%;
  padding: 0.5rem;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.875rem;
  transition: all 0.2s;
}

.btn-logout:hover {
  background: var(--gray);
  color: white;
}

/* Chat Main Area */
.chat-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  max-width: 900px;
  margin: 0 auto;
  width: 100%;
}

.chat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem 2rem;
  border-bottom: 1px solid var(--border);
  background: var(--dark);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.btn-menu {
  background: transparent;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
}

.chat-title h1 {
  font-size: 1.5rem;
  margin-bottom: 0.25rem;
}

.chat-subtitle {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.header-right {
  display: flex;
  gap: 0.5rem;
}

.btn-icon {
  position: relative;
  width: 40px;
  height: 40px;
  background: var(--gray);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  transition: all 0.2s;
}

.btn-icon:hover {
  background: var(--border);
}

.tooltip {
  position: absolute;
  top: -35px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--gray);
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  font-size: 0.75rem;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}

.btn-icon:hover .tooltip {
  opacity: 1;
}

/* Messages Container */
.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 2rem;
  scroll-behavior: smooth;
}

.welcome-section {
  text-align: center;
  max-width: 500px;
  margin: 4rem auto;
}

.welcome-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.welcome-section h2 {
  font-size: 2rem;
  margin-bottom: 0.75rem;
}

.welcome-section p {
  font-size: 1.125rem;
  color: var(--text-secondary);
  margin-bottom: 2rem;
}

.quick-actions {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.quick-action {
  padding: 1rem;
  background: var(--gray);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: white;
  cursor: pointer;
  font-size: 0.9375rem;
  text-align: left;
  transition: all 0.2s;
}

.quick-action:hover {
  background: var(--border);
  transform: translateY(-2px);
}

/* Message Bubbles */
.message {
  display: flex;
  margin-bottom: 1.5rem;
  animation: slideIn 0.3s ease-out;
}

.message.user {
  justify-content: flex-end;
}

.message-bubble {
  max-width: 70%;
  padding: 1rem 1.25rem;
  border-radius: 16px;
  word-wrap: break-word;
}

.message.ai .message-bubble {
  background: var(--gray);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}

.message.user .message-bubble {
  background: var(--gradient);
  border-bottom-right-radius: 4px;
}

.message-content {
  font-size: 1rem;
  line-height: 1.6;
  white-space: pre-wrap;
}

.message-timestamp {
  font-size: 0.75rem;
  color: var(--text-tertiary);
  margin-top: 0.5rem;
}

/* Video Cards */
.video-cards {
  margin-top: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.video-card {
  background: var(--dark);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.2s;
}

.video-card:hover {
  border-color: var(--primary);
  transform: translateY(-2px);
}

.video-thumbnail {
  position: relative;
  width: 100%;
  aspect-ratio: 16/9;
  background: var(--black);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
}

.video-thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.play-overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 60px;
  height: 60px;
  background: rgba(0, 0, 0, 0.8);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
}

.video-info {
  padding: 1rem;
}

.video-title {
  font-weight: 600;
  font-size: 0.9375rem;
  margin-bottom: 0.25rem;
}

.video-meta {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.video-actions {
  display: flex;
  gap: 0.5rem;
  padding: 0 1rem 1rem;
}

.btn-video {
  flex: 1;
  padding: 0.5rem;
  border: none;
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-watch {
  background: var(--gradient);
  color: white;
}

.btn-save {
  background: var(--gray);
  border: 1px solid var(--border);
  color: white;
}

.btn-save:hover {
  background: var(--border);
}

/* Typing Indicator */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0 2rem 1rem;
}

.typing-dots {
  display: flex;
  gap: 0.25rem;
}

.typing-dots span {
  width: 8px;
  height: 8px;
  background: var(--text-secondary);
  border-radius: 50%;
  animation: pulse 1.4s ease-in-out infinite;
}

.typing-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

.typing-text {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

/* Input Area */
.input-area {
  padding: 1.5rem 2rem;
  border-top: 1px solid var(--border);
  background: var(--dark);
}

.input-container {
  display: flex;
  gap: 0.75rem;
  align-items: flex-end;
}

.btn-voice {
  width: 44px;
  height: 44px;
  background: var(--gray);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: white;
  cursor: pointer;
  font-size: 1.25rem;
  transition: all 0.2s;
  flex-shrink: 0;
}

.btn-voice:hover {
  background: var(--border);
}

.btn-voice.recording {
  background: #dc2626;
  border-color: #dc2626;
  animation: pulse 1s ease-in-out infinite;
}

.message-input {
  flex: 1;
  min-height: 44px;
  max-height: 150px;
  padding: 0.75rem 1rem;
  background: var(--gray);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: white;
  font-size: 1rem;
  font-family: inherit;
  resize: none;
  overflow-y: auto;
}

.message-input:focus {
  outline: none;
  border-color: var(--primary);
}

.message-input::placeholder {
  color: var(--text-tertiary);
}

.btn-send {
  width: 44px;
  height: 44px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  position: relative;
  transition: all 0.2s;
  flex-shrink: 0;
}

.btn-send:hover {
  transform: scale(1.05);
}

.btn-send:active {
  transform: scale(0.95);
}

.btn-send:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Belt-colored send button */
.btn-send.belt-white {
  background: var(--belt-white);
  color: #000000;
}

.btn-send.belt-blue {
  background: var(--belt-blue);
  color: white;
}

.btn-send.belt-purple {
  background: var(--belt-purple);
  color: white;
}

.btn-send.belt-brown {
  background: var(--belt-brown);
  color: white;
}

.btn-send.belt-black {
  background: var(--belt-black);
  color: white;
  border: 1px solid var(--border);
}

/* Stripes on send button */
.btn-send:after {
  content: '';
  position: absolute;
  bottom: 6px;
  left: 10px;
  right: 10px;
  height: 2px;
  background: repeating-linear-gradient(
    to right,
    white 0px,
    white 4px,
    transparent 4px,
    transparent 8px
  );
}

.btn-send.belt-black:after {
  background: repeating-linear-gradient(
    to right,
    #dc2626 0px,
    #dc2626 4px,
    transparent 4px,
    transparent 8px
  );
}

.send-icon {
  font-size: 1.25rem;
  font-weight: 700;
}

.input-footer {
  margin-top: 0.75rem;
  text-align: center;
}

.input-hint {
  font-size: 0.75rem;
  color: var(--text-tertiary);
}

/* History Panel */
.history-panel {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  width: 320px;
  background: var(--dark);
  border-left: 1px solid var(--border);
  z-index: 200;
  transform: translateX(100%);
  transition: transform 0.3s ease;
}

.history-panel:not(.hidden) {
  transform: translateX(0);
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.history-header h3 {
  font-size: 1.125rem;
}

.btn-close {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
}

.history-list {
  overflow-y: auto;
  height: calc(100% - 80px);
  padding: 1rem;
}

.history-item {
  padding: 1rem;
  background: var(--gray);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 0.75rem;
  cursor: pointer;
  transition: all 0.2s;
}

.history-item:hover {
  background: var(--border);
}

.history-date {
  font-size: 0.75rem;
  color: var(--text-tertiary);
  margin-bottom: 0.5rem;
}

.history-preview {
  font-size: 0.875rem;
  color: var(--text-secondary);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Mobile Styles */
.mobile-only {
  display: none;
}

.mobile-nav {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--dark);
  border-top: 1px solid var(--border);
  padding: 0.75rem 0;
  z-index: 100;
}

.mobile-nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 0.75rem;
}

.mobile-nav-item span:first-child {
  font-size: 1.5rem;
}

.mobile-nav-item.active {
  color: var(--primary);
}

@media (max-width: 768px) {
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: 300;
  }
  
  .sidebar.open {
    transform: translateX(0);
  }
  
  .mobile-only {
    display: block;
  }
  
  .mobile-nav {
    display: flex;
    justify-content: space-around;
  }
  
  .chat-main {
    max-width: 100%;
  }
  
  .chat-header {
    padding: 1rem;
  }
  
  .messages-container {
    padding: 1rem;
    padding-bottom: 80px;
  }
  
  .input-area {
    padding: 1rem;
    padding-bottom: 80px;
  }
  
  .message-bubble {
    max-width: 85%;
  }
}

/* Animations */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 0.6;
    transform: scale(1);
  }
  50% {
    opacity: 1;
    transform: scale(1.2);
  }
}

.hidden {
  display: none !important;
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PART 3: WEB CHAT JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Create /public/scripts/chat.js:

// User data
let userId = localStorage.getItem('userId');
let userBelt = localStorage.getItem('userBelt') || 'blue';
let userName = localStorage.getItem('userName') || 'User';
let currentChatId = null;
let isRecording = false;
let recognition = null;

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
  // Check auth
  if (!userId) {
    window.location.href = '/login';
    return;
  }
  
  // Load user profile
  await loadUserProfile();
  
  // Load chat history
  await loadChatHistory();
  
  // Apply belt color to send button
  applybeltColor();
  
  // Auto-resize textarea
  const textarea = document.getElementById('message-input');
  textarea.addEventListener('input', () => {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
  });
  
  // Initialize speech recognition
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    
    recognition.onresult = (event) => {
      let transcript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        transcript += event.results[i][0].transcript;
      }
      document.getElementById('message-input').value = transcript;
    };
    
    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      stopVoice();
    };
    
    recognition.onend = () => {
      if (isRecording) {
        stopVoice();
      }
    };
  }
});

// Load user profile
async function loadUserProfile() {
  try {
    const response = await fetch(`/api/ai/user/${userId}/context`);
    const data = await response.json();
    
    if (data.user) {
      userName = data.user.name || 'User';
      userBelt = data.user.belt_level?.toLowerCase() || 'blue';
      
      localStorage.setItem('userName', userName);
      localStorage.setItem('userBelt', userBelt);
      
      // Update UI
      document.getElementById('user-name').textContent = userName;
      document.getElementById('user-initials').textContent = userName.split(' ').map(n => n[0]).join('');
      
      const beltBadge = document.querySelector('.belt-badge');
      beltBadge.className = `belt-badge ${userBelt}`;
      beltBadge.textContent = `${userBelt.charAt(0).toUpperCase() + userBelt.slice(1)} Belt`;
    }
  } catch (error) {
    console.error('Failed to load profile:', error);
  }
}

// Apply belt color to send button
function applyBeltColor() {
  const sendBtn = document.getElementById('send-btn');
  sendBtn.className = `btn-send belt-${userBelt}`;
}

// Load chat history
async function loadChatHistory() {
  try {
    const response = await fetch(`/api/ai/chat/history/${userId}?limit=50`);
    const data = await response.json();
    
    if (data.messages && data.messages.length > 0) {
      // Hide welcome section
      document.querySelector('.welcome-section')?.remove();
      
      // Display messages
      data.messages.forEach(msg => {
        displayMessage(msg.message, msg.sender, msg.timestamp, msg.videos);
      });
      
      // Scroll to bottom
      scrollToBottom();
    }
  } catch (error) {
    console.error('Failed to load chat history:', error);
  }
}

// Send message
async function sendMessage() {
  const input = document.getElementById('message-input');
  const message = input.value.trim();
  
  if (!message) return;
  
  // Clear input
  input.value = '';
  input.style.height = 'auto';
  
  // Hide welcome if present
  document.querySelector('.welcome-section')?.remove();
  
  // Display user message
  displayMessage(message, 'user', new Date());
  
  // Show typing indicator
  showTyping();
  
  try {
    // Send to API
    const response = await fetch('/api/ai/chat/message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, message })
    });
    
    const data = await response.json();
    
    // Hide typing
    hideTyping();
    
    // Display AI response
    displayMessage(data.message, 'ai', new Date(data.timestamp), data.videos);
    
    // Scroll to bottom
    scrollToBottom();
    
  } catch (error) {
    console.error('Failed to send message:', error);
    hideTyping();
    displayMessage("Sorry, I'm having trouble right now. Please try again!", 'ai', new Date());
  }
}

// Send quick message
function sendQuickMessage(message) {
  document.getElementById('message-input').value = message;
  sendMessage();
}

// Display message
function displayMessage(text, sender, timestamp, videos = []) {
  const container = document.getElementById('messages');
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}`;
  
  const bubble = document.createElement('div');
  bubble.className = 'message-bubble';
  
  const content = document.createElement('div');
  content.className = 'message-content';
  content.textContent = text;
  
  bubble.appendChild(content);
  
  // Add videos if present
  if (videos && videos.length > 0) {
    const videoCards = document.createElement('div');
    videoCards.className = 'video-cards';
    
    videos.forEach(video => {
      const card = createVideoCard(video);
      videoCards.appendChild(card);
    });
    
    bubble.appendChild(videoCards);
  }
  
  const time = document.createElement('div');
  time.className = 'message-timestamp';
  time.textContent = formatTime(timestamp);
  
  bubble.appendChild(time);
  messageDiv.appendChild(bubble);
  container.appendChild(messageDiv);
}

// Create video card
function createVideoCard(video) {
  const card = document.createElement('div');
  card.className = 'video-card';
  
  card.innerHTML = `
    <div class="video-thumbnail" onclick="openVideo('${video.videoUrl}')">
      ${video.thumbnailUrl 
        ? `<img src="${video.thumbnailUrl}" alt="${video.title}">` 
        : '<span>â–¶ï¸</span>'
      }
      <div class="play-overlay">â–¶</div>
    </div>
    <div class="video-info">
      <div class="video-title">${video.title}</div>
      <div class="video-meta">${video.instructor} â€¢ ${video.duration}</div>
    </div>
    <div class="video-actions">
      <button class="btn-video btn-watch" onclick="openVideo('${video.videoUrl}')">
        â–¶ï¸ Watch
      </button>
      <button class="btn-video btn-save" onclick="saveVideo('${video.id}')">
        â¤ï¸ Save
      </button>
    </div>
  `;
  
  return card;
}

// Open video
function openVideo(url) {
  window.open(url, '_blank');
}

// Save video
async function saveVideo(videoId) {
  try {
    await fetch('/api/ai/saved-videos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, videoId })
    });
    
    // Show feedback
    showNotification('Video saved! âœ…');
  } catch (error) {
    console.error('Failed to save video:', error);
    showNotification('Failed to save video');
  }
}

// Typing indicator
function showTyping() {
  document.getElementById('typing').classList.remove('hidden');
  scrollToBottom();
}

function hideTyping() {
  document.getElementById('typing').classList.add('hidden');
}

// Voice recording
function toggleVoice() {
  if (!recognition) {
    alert('Voice input not supported in this browser');
    return;
  }
  
  if (isRecording) {
    stopVoice();
  } else {
    startVoice();
  }
}

function startVoice() {
  isRecording = true;
  const btn = document.getElementById('voice-btn');
  btn.classList.add('recording');
  recognition.start();
}

function stopVoice() {
  isRecording = false;
  const btn = document.getElementById('voice-btn');
  btn.classList.remove('recording');
  if (recognition) recognition.stop();
}

// Handle keyboard
function handleKeyPress(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
}

// Scroll to bottom
function scrollToBottom() {
  const container = document.getElementById('messages');
  container.scrollTop = container.scrollHeight;
}

// Format time
function formatTime(date) {
  const d = new Date(date);
  return d.toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit' 
  });
}

// Show notification
function showNotification(message) {
  // Simple alert for now - can be enhanced with toast notifications
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    bottom: 100px;
    right: 20px;
    background: var(--gradient);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// New chat
function newChat() {
  // Clear messages
  const container = document.getElementById('messages');
  container.innerHTML = '';
  
  // Show welcome section
  const welcome = document.createElement('div');
  welcome.className = 'welcome-section';
  welcome.innerHTML = `
    <div class="welcome-icon">ğŸ¥‹</div>
    <h2>Hey! I'm Prof. OS</h2>
    <p>Your personal BJJ coach powered by AI. Ask me anything about techniques, game plans, or your training.</p>
    
    <div class="quick-actions">
      <button class="quick-action" onclick="sendQuickMessage('Show me some guard videos')">
        ğŸ¬ Show me guard videos
      </button>
      <button class="quick-action" onclick="sendQuickMessage('I need help passing half guard')">
        ğŸ¤” Help with passing
      </button>
      <button class="quick-action" onclick="sendQuickMessage('What should I focus on as a blue belt?')">
        ğŸ¯ Training advice
      </button>
    </div>
  `;
  container.appendChild(welcome);
}

// Toggle history panel
function toggleHistory() {
  document.getElementById('history-panel').classList.toggle('hidden');
}

// Toggle sidebar (mobile)
function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('open');
}

// Logout
function logout() {
  localStorage.removeItem('userId');
  localStorage.removeItem('userBelt');
  localStorage.removeItem('userName');
  window.location.href = '/';
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VERIFICATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

After Command 3:

1. Login as user
2. Visit /chat
3. Should see:
   - Sidebar with BJJ OS branding
   - Prof. OS as AI agent name in chat
   - Welcome message from Prof. OS
   - Quick action buttons
   - Belt-colored send button with stripes
   - Black belt users get RED stripes (not white)
4. Test sending messages
5. Test voice input
6. Test video recommendations
7. Test on mobile - bottom nav should work
8. Verify all 29 AI features accessible

Next: Command 4 will build admin dashboard with:
- Free lifetime membership management
- Referral code system (20% recurring)
- User analytics
- Subscription management
```

-----

**ğŸ“‹ PASTE COMMAND 3 INTO REPLIT AGENT NOW**

Let me know when complete and Iâ€™ll give you Command 4 (Admin Dashboard)! ğŸš€â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹
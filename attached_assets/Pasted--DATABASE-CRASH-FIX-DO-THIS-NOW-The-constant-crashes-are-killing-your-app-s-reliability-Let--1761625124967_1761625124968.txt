# ğŸš¨ DATABASE CRASH FIX - DO THIS NOW

The constant crashes are killing your appâ€™s reliability. Letâ€™s fix this immediately.

-----

# ğŸ”§ EMERGENCY DATABASE CONNECTION FIX

Copy this prompt and send to Replit Agent:

-----

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FIX DATABASE CONNECTION CRASHES - ADD PROPER CONNECTION POOLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CRITICAL ISSUE:
Database keeps crashing with "transient database crash (Supabase issue)"

ROOT CAUSE:
- Too many simultaneous connections
- Connections not being properly closed
- No connection pooling
- Supabase connection limits being exceeded

SOLUTION:
Implement proper connection pooling with retry logic and connection limits

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 1: UPDATE DATABASE CONNECTION FILE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FIND FILE: /server/db.js or /server/db.ts (wherever database connection is set up)

REPLACE the entire database connection setup with this:

```javascript
const { Pool } = require('pg');

// Create connection pool with proper settings
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  
  // Connection pool settings
  max: 10,                      // Maximum 10 connections (Supabase free tier limit)
  min: 2,                       // Keep 2 connections always ready
  idleTimeoutMillis: 30000,     // Close idle connections after 30s
  connectionTimeoutMillis: 5000, // Timeout after 5s if can't connect
  
  // SSL settings for Supabase
  ssl: {
    rejectUnauthorized: false
  }
});

// Handle pool errors
pool.on('error', (err, client) => {
  console.error('âŒ Unexpected database pool error:', err);
});

// Query wrapper with automatic retry
async function query(text, params, retries = 3) {
  let lastError;
  
  for (let attempt = 1; attempt <= retries; attempt++) {
    try {
      const client = await pool.connect();
      try {
        const result = await client.query(text, params);
        return result;
      } finally {
        client.release(); // CRITICAL: Always release connection back to pool
      }
    } catch (error) {
      lastError = error;
      console.error(`âŒ Database query error (attempt ${attempt}/${retries}):`, error.message);
      
      // Don't retry on syntax errors
      if (error.message.includes('syntax error') || error.message.includes('does not exist')) {
        throw error;
      }
      
      // Wait before retry (exponential backoff)
      if (attempt < retries) {
        const waitTime = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
        console.log(`â³ Retrying in ${waitTime}ms...`);
        await new Promise(resolve => setTimeout(resolve, waitTime));
      }
    }
  }
  
  throw lastError;
}

// Health check function
async function checkConnection() {
  try {
    const result = await query('SELECT NOW()');
    console.log('âœ… Database connection healthy');
    return true;
  } catch (error) {
    console.error('âŒ Database connection failed:', error.message);
    return false;
  }
}

// Graceful shutdown
process.on('SIGTERM', async () => {
  console.log('ğŸ“Š Closing database pool...');
  await pool.end();
});

module.exports = {
  query,
  pool,
  checkConnection
};
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 2: UPDATE ALL DATABASE QUERIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Find all files that use database queries and update them:

OLD WAY (causes crashes):

```javascript
const result = await db.query('SELECT * FROM users');
```

NEW WAY (with pooling):

```javascript
const { query } = require('./db');
const result = await query('SELECT * FROM users');
```

The key changes:

- Import { query } instead of direct db
- Use query() instead of db.query()
- Connections are automatically managed and released

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 3: ADD DATABASE HEALTH CHECK ON STARTUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

In /server/index.ts (main server file), add this at startup:

```javascript
const { checkConnection } = require('./db');

// Check database on startup
(async () => {
  console.log('');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('ğŸ” DATABASE CONNECTION CHECK');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  const isConnected = await checkConnection();
  
  if (!isConnected) {
    console.error('âŒ CRITICAL: Cannot connect to database');
    console.error('   Check DATABASE_URL in environment variables');
    process.exit(1);
  }
  
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('');
})();
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 4: ADD CONNECTION MONITORING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Add this to monitor connection health:

```javascript
// Check connection every 5 minutes
setInterval(async () => {
  try {
    const { pool } = require('./db');
    console.log('ğŸ“Š DB Pool Status:', {
      total: pool.totalCount,
      idle: pool.idleCount,
      waiting: pool.waitingCount
    });
    
    // Warn if too many waiting connections
    if (pool.waitingCount > 5) {
      console.warn('âš ï¸ Many queries waiting for connections - may need to increase pool size');
    }
  } catch (error) {
    console.error('âŒ Pool status check failed:', error);
  }
}, 5 * 60 * 1000);
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 5: VERIFY SUPABASE CONNECTION STRING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Check your .env file has the correct format:

DATABASE_URL=postgresql://postgres:[PASSWORD]@[HOST]:5432/postgres?pgbouncer=true

IMPORTANT: Add `?pgbouncer=true` at the end for Supabase connection pooling

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 6: TEST THE FIX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

After implementing, restart the server and run:

const { query, checkConnection } = require(â€™./dbâ€™);

// Test connection
await checkConnection();

// Test query
const result = await query(â€˜SELECT COUNT(*) FROM usersâ€™);
console.log(â€˜User count:â€™, result.rows[0].count);

Check console for:
âœ… â€œDatabase connection healthyâ€
âœ… No more crash errors
âœ… Pool status logs

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
WHY THIS FIXES THE CRASHES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BEFORE (crashes):

- Every query creates new connection
- Connections not properly closed
- Exceeds Supabase connection limit (10)
- Random crashes when limit reached

AFTER (stable):

- Reuses existing connections from pool
- Max 10 connections (respects Supabase limit)
- Connections automatically released
- Retry logic handles temporary network issues
- Exponential backoff prevents overwhelming database
- Proper error handling

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SUCCESS CRITERIA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… No more â€œtransient database crashâ€ errors
âœ… Database health check passes on startup
âœ… Pool status shows healthy connections
âœ… Queries automatically retry on failure
âœ… Connections properly released after use
âœ… Console logs show pool status every 5 minutes

IMPLEMENT ALL STEPS NOW. This will stop the crashes permanently.

```
---

## âœ… **WHAT THIS FIX DOES:**

1. âœ… **Connection Pooling** - Reuses connections instead of creating new ones
2. âœ… **Automatic Retry** - Retries failed queries up to 3 times
3. âœ… **Proper Cleanup** - Releases connections back to pool
4. âœ… **Connection Limits** - Respects Supabase's 10 connection limit
5. âœ… **Health Monitoring** - Checks database health regularly
6. âœ… **Graceful Errors** - Handles crashes without killing the app

---

## ğŸ¯ **SEND THIS TO REPLIT AGENT NOW**

This will **permanently fix** the database crashes. The crashes are happening because you're exhausting Supabase's connection limit. This fix implements proper connection pooling so that never happens again.

**After this fix, you should NEVER see "transient database crash" again!** ğŸš€ğŸ’ªâ€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹
```
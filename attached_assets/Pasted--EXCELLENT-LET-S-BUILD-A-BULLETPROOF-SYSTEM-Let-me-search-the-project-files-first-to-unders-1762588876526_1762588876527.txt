**EXCELLENT - LETâ€™S BUILD A BULLETPROOF SYSTEM** ğŸ¯

Let me search the project files first to understand current implementation:â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹

**PERFECT - I HAVE EVERYTHING. LETâ€™S BUILD THE COMPLETE SYSTEM** ğŸš€

-----

# **ğŸ“‹ PART 1: COMPLETE HYBRID AI ROUTING SYSTEM**

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MISSION CRITICAL: IMPLEMENT HYBRID AI MODEL ROUTING (3-TIER SYSTEM)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CURRENT PROBLEM:
- Using Claude Sonnet 4.5 for everything (slow + expensive)
- 5-8 second response times
- $50/day AI costs at scale

NEW SOLUTION: 
- Tier 1: Claude Haiku 4 for simple queries (<1 sec, 95% cheaper)
- Tier 2: GPT-4o for standard coaching (2-3 sec, 40% cheaper)
- Tier 3: Claude Sonnet 4.5 for deep intelligence (5-8 sec, reserved for magic)

EXPECTED RESULTS:
- 3x faster average response time
- 50% cost reduction
- Same or better user experience

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 1: ADD QUERY TYPE DETECTION FUNCTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

File: server/routes.ts

Add this function BEFORE the chat endpoint:

function detectQueryType(message: string, conversationHistory: any[]): string {
  const lower = message.toLowerCase().trim();
  const isFirstMessage = conversationHistory.length === 0;
  
  // ==========================================
  // TIER 1: SIMPLE FACTUAL (Use Haiku)
  // ==========================================
  
  // Greetings
  if (lower.match(/^(hey|hi|hello|sup|what's up|yo|wassup)/i) && message.length < 30) {
    return 'simple_factual';
  }
  
  // Profile questions
  if (
    lower.match(/how (tall|old|much do i weigh|heavy)/i) ||
    lower.match(/what('s| is) my (height|weight|age|belt)/i) ||
    lower.includes('when did i start') ||
    lower.includes('how long have i been')
  ) {
    return 'simple_factual';
  }
  
  // Off-topic questions
  if (
    lower.includes('weather') ||
    lower.includes('dinner') ||
    lower.includes('joke') ||
    lower.includes('recipe') ||
    lower.includes('movie') ||
    (lower.includes('what') && !lower.includes('bjj') && !lower.includes('jiu'))
  ) {
    return 'simple_factual';
  }
  
  // Simple yes/no
  if (message.length < 20 && (lower.includes('?') || lower.match(/^(yes|no|yeah|nah|maybe)/i))) {
    return 'simple_factual';
  }
  
  // ==========================================
  // TIER 3: CRITICAL MOMENTS (Use Sonnet)
  // ==========================================
  
  // First message (set the tone perfectly)
  if (isFirstMessage) {
    return 'critical_moment';
  }
  
  // Competition prep
  if (
    lower.includes('competing') ||
    lower.includes('tournament') ||
    lower.includes('competition') ||
    lower.includes('comp prep')
  ) {
    return 'critical_moment';
  }
  
  // Injury mentions
  if (
    lower.includes('injured') ||
    lower.includes('injury') ||
    lower.includes('hurt') ||
    lower.includes('pain') && !lower.includes('painful technique')
  ) {
    return 'critical_moment';
  }
  
  // Breakthrough moments
  if (
    lower.includes('first time') ||
    lower.includes('finally hit') ||
    lower.includes('breakthrough') ||
    (lower.includes('!') && lower.includes('got it'))
  ) {
    return 'critical_moment';
  }
  
  // Plateau/frustration
  if (
    lower.includes('plateau') ||
    lower.includes('stuck') ||
    lower.includes('not improving') ||
    (lower.includes('nothing works') || lower.includes('nothing is working'))
  ) {
    return 'critical_moment';
  }
  
  // Monthly review
  const lastMessages = conversationHistory.slice(-5);
  const hasntChatInWeek = lastMessages.length === 0 || 
    (lastMessages[0]?.created_at && 
     (Date.now() - new Date(lastMessages[0].created_at).getTime()) > 7 * 24 * 60 * 60 * 1000);
  
  if (hasntChatInWeek && conversationHistory.length > 20) {
    return 'critical_moment';
  }
  
  // ==========================================
  // TIER 2: STANDARD COACHING (Use GPT-4o)
  // ==========================================
  
  // Everything else = standard coaching
  return 'standard_coaching';
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 2: UPDATE CHAT ENDPOINT WITH HYBRID ROUTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

File: server/routes.ts (main chat endpoint)

Replace the existing dual-model routing with this:

app.post('/api/chat/professor-os', requireAuth, async (req, res) => {
  try {
    const userId = req.user.id;
    const { message } = req.body;
    
    // 1. LOAD USER PROFILE
    const profile = await db.query.user_profiles.findFirst({
      where: eq(user_profiles.user_id, userId),
      with: { user: true }
    });
    
    if (!profile) {
      return res.status(404).json({ error: 'Profile not found' });
    }
    
    // 2. LOAD CONVERSATION HISTORY (Last 10 messages for context)
    const history = await db.query.chat_messages.findMany({
      where: eq(chat_messages.user_id, userId),
      orderBy: [desc(chat_messages.created_at)],
      limit: 10
    });
    
    const conversationHistory = history.reverse();
    
    // 3. DETECT QUERY TYPE
    const queryType = detectQueryType(message, conversationHistory);
    
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('HYBRID ROUTING DECISION');
    console.log('Query:', message.substring(0, 60) + '...');
    console.log('Type:', queryType);
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    // 4. BUILD SYSTEM PROMPT
    const systemPrompt = buildSystemPrompt({
      user: {
        displayName: profile.first_name,
        beltLevel: profile.belt_level,
        style: profile.training_style,
        struggleTechnique: profile.biggest_struggle,
        height: profile.height,
        weight: profile.weight,
        birthYear: profile.birth_year,
        trainingFrequency: profile.training_frequency,
        createdAt: profile.user.created_at
      }
    }, availableVideos);
    
    // 5. FORMAT CONVERSATION HISTORY
    const messages = conversationHistory.map(msg => ({
      role: msg.role,
      content: msg.content
    }));
    
    messages.push({
      role: 'user',
      content: message
    });
    
    // 6. ROUTE TO APPROPRIATE MODEL
    let aiResponse: string;
    let modelUsed: string;
    const startTime = Date.now();
    
    if (queryType === 'simple_factual') {
      // ===== TIER 1: CLAUDE HAIKU 4 (FASTEST + CHEAPEST) =====
      console.log('â†’ Using Claude Haiku 4 (simple query)');
      
      const response = await anthropic.messages.create({
        model: 'claude-haiku-4-20250514',
        max_tokens: 1024,  // Shorter for simple queries
        system: systemPrompt,
        messages: messages
      });
      
      aiResponse = response.content[0].type === 'text' ? response.content[0].text : '';
      modelUsed = 'claude-haiku-4';
      
    } else if (queryType === 'critical_moment') {
      // ===== TIER 3: CLAUDE SONNET 4.5 (DEEPEST INTELLIGENCE) =====
      console.log('â†’ Using Claude Sonnet 4.5 (critical moment)');
      
      const response = await anthropic.messages.create({
        model: 'claude-sonnet-4-5-20250929',
        max_tokens: 2048,
        system: systemPrompt,
        messages: messages
      });
      
      aiResponse = response.content[0].type === 'text' ? response.content[0].text : '';
      modelUsed = 'claude-sonnet-4-5';
      
    } else {
      // ===== TIER 2: GPT-4o (STANDARD COACHING) =====
      console.log('â†’ Using GPT-4o (standard coaching)');
      
      const response = await openai.chat.completions.create({
        model: 'gpt-4o',
        max_tokens: 2048,
        messages: [
          { role: 'system', content: systemPrompt },
          ...messages
        ],
        temperature: 0.7
      });
      
      aiResponse = response.choices[0]?.message?.content || '';
      modelUsed = 'gpt-4o';
    }
    
    const responseTime = Date.now() - startTime;
    
    console.log('Response time:', responseTime + 'ms');
    console.log('Model used:', modelUsed);
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    // 7. SAVE MESSAGES TO DATABASE
    await db.insert(chat_messages).values({
      user_id: userId,
      role: 'user',
      content: message,
      created_at: new Date()
    });
    
    await db.insert(chat_messages).values({
      user_id: userId,
      role: 'assistant',
      content: aiResponse,
      model_used: modelUsed,
      response_time_ms: responseTime,
      created_at: new Date()
    });
    
    // 8. RETURN RESPONSE
    res.json({ 
      message: aiResponse,
      metadata: {
        model: modelUsed,
        responseTime: responseTime,
        queryType: queryType
      }
    });
    
  } catch (error) {
    console.error('Professor OS error:', error);
    res.status(500).json({ error: 'Failed to get response' });
  }
});

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 3: ADD REQUIRED API KEYS TO .env
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Make sure your .env file has:

ANTHROPIC_API_KEY=sk-ant-...  # For Claude Haiku & Sonnet
OPENAI_API_KEY=sk-...          # For GPT-4o

Both models available:
- claude-haiku-4-20250514 (Tier 1)
- gpt-4o (Tier 2)
- claude-sonnet-4-5-20250929 (Tier 3)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**SEND PART 1 TO REPLIT AGENT NOW** â¬†ï¸

This implements the complete 3-tier routing system. Once this is done, Iâ€™ll give you Part 2: The comprehensive testing suite.

Want me to continue with the testing framework?â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹
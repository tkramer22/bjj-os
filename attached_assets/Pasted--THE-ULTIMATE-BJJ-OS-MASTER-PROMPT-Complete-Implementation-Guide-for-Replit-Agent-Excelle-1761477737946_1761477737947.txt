# ðŸ† THE ULTIMATE BJJ OS MASTER PROMPT

## Complete Implementation Guide for Replit Agent

**Excellence is our pillar. This document contains everything needed to build the worldâ€™s most intelligent BJJ coaching application.**

-----

## ðŸ“‹ TABLE OF CONTENTS

1. Executive Summary
1. Elite AI System Prompts (5 modes)
1. Technical Architecture
1. Database Schema
1. Video Curation & Timestamping System
1. Feature Specifications (9 launch features)
1. API Endpoints
1. Implementation Sequence
1. Testing & Deployment

-----

# 1. EXECUTIVE SUMMARY

## What Weâ€™re Building

**BJJ OS** - An AI-powered Brazilian Jiu-Jitsu coaching application featuring **Professor OS**, the worldâ€™s most intelligent BJJ coaching AI.

## Core Value Proposition

Unlike generic fitness trackers or video libraries, BJJ OS provides:

- **Intelligent coaching** that remembers every detail of your training
- **Pattern detection** that spots issues before they become chronic
- **Personalized recommendations** based on your actual performance data
- **Curated video library** with precise timestamps (not 10,000 random videos)
- **Competition preparation** with AI-generated gameplans
- **Progress tracking** that reveals your BJJ identity over time

## Technology Stack

**Frontend:**

- React with Wouter routing
- Vite for development
- Progressive Web App (PWA) capabilities

**Backend:**

- Node.js with Express
- PostgreSQL database
- Prisma ORM

**AI Services:**

- **Claude Sonnet 4** (Anthropic) - Main coaching intelligence
- **GPT-4o** (OpenAI) - Video analysis & pre-filtering
- **Whisper** (OpenAI) - Voice transcription
- **ElevenLabs** - Voice synthesis (Month 4+)

**External Services:**

- Clerk - Authentication
- Stripe - Payment processing
- YouTube Data API v3 - Video discovery
- Twilio - SMS (optional)

**Infrastructure:**

- Hosted on Replit
- Custom domain: bjjos.app

-----

# 2. ELITE AI SYSTEM PROMPTS

## Professor OS has 5 distinct modes, each with specialized behavior:

### MODE 1: POST-SESSION COACHING

**[See full system prompt in previous message - SYSTEM PROMPT 1]**

Key characteristics:

- Active listening (references specific details from session)
- Pattern recognition (connects to training history)
- Contextual reframing (struggles â†’ productive direction)
- One clear focus (never overwhelms with multiple priorities)
- Video recommendations with WHY
- Forward momentum (ends with engagement)

-----

### MODE 2: PRE-TRAINING FOCUS

**[See full system prompt in previous message - SYSTEM PROMPT 2]**

Key characteristics:

- Analyzes last 5-7 sessions
- Identifies THE ONE priority for today
- Gives specific, actionable direction
- Connects to recent patterns
- Expected outcome stated clearly

-----

### MODE 3: TECHNIQUE QUERY

**[See full system prompt in previous message - SYSTEM PROMPT 3]**

Key characteristics:

- Multi-instructor perspective (attributes details to specific black belts)
- 3-5 key details per technique
- Common mistakes section
- Belt-appropriate video recommendations with timestamps
- Qualitative success ratings (Extremely High/High/Moderate)

-----

### MODE 4: GENERAL CONVERSATION

```
You are Professor OS in GENERAL CONVERSATION MODE.

The user is asking a general question or having casual conversation about BJJ (not logging session, not asking for pre-training focus, not querying specific technique).

Examples:
- "Should I compete?"
- "How do I deal with bigger opponents?"
- "I'm feeling discouraged"
- "What's the difference between gi and no-gi?"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
YOUR APPROACH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PRINCIPLE: Be their training partner having a conversation, not a professor lecturing.

RESPONSE STRUCTURE:
1. Acknowledge their question/concern
2. Share relevant perspective (draw from your deep BJJ knowledge)
3. Connect to THEIR specific situation if possible
4. Give actionable takeaway if appropriate
5. Ask follow-up question OR make supportive statement

TONE:
- Conversational, like talking to an upper belt friend
- Direct but supportive
- Share wisdom without preaching
- Use examples from elite practitioners when relevant

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EXAMPLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**User: "Should I compete?"**

Response:
"That's a personal call, but here's how to think about it:

Competing accelerates learningâ€”you'll improve faster in 3 months preparing for a tournament than 6 months of casual training. The pressure reveals gaps in your game you can't find in regular training.

But it's also stressful. Some people love competition (it drives them), others hate it (takes the fun away).

Looking at your trainingâ€”you've been consistent for 4 months, you have a solid closed guard game. You're ready skill-wise. Question is: do you WANT to compete, or do you feel like you SHOULD?

What's your gut telling you?"

**User: "I'm feeling discouraged. Been training 6 months and still getting destroyed."**

Response:
"6 months is EARLY. You're still a white beltâ€”getting destroyed is the job description.

Here's what I see in your data: You've logged 68 sessions in 6 months. That's consistent. You've learned 23 techniques. Your triangle success rate went from 0% (month 1-2) to 15% (month 5-6). You're improvingâ€”you just can't see it day-to-day.

Rickson Gracie has a great perspective on this: 'In jiu jitsu, you're always the nail first, then slowly you become the hammer.' You're in the nail phase. Everyone goes through it.

The people destroying you now? They were in your exact position 2-3 years ago getting destroyed by someone else.

What specific thing is frustrating you most? Let's fix one thing."

**User: "What's better, gi or no-gi?"**

Response:
"Different, not better. Both develop your jiu jitsu, just different aspects.

Gi = slower, more technical, grip-fighting heavy. Forces you to solve problems methodically. Better for patience and detail work.

No-gi = faster, more athletic, scramble-heavy. Forces you to solve problems explosively. Better for timing and pressure.

Elite competitors train both. Gordon Ryan (best no-gi ever) still trains gi. Roger Gracie (best gi ever) trained no-gi.

You've been training gi so far. What made you curious about no-gi?"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESPONSE LENGTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â€¢ 150-250 words for general questions
â€¢ Can be shorter for simple questions (50-100 words)
â€¢ Never exceed 300 words

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CRITICAL RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Reference their training history when relevant
âœ“ Give perspective from elite practitioners
âœ“ Validate their feelings/concerns
âœ“ Always provide actionable direction when appropriate
âœ“ End with engagement (question or supportive statement)

âœ— Never be dismissive of concerns
âœ— Never give generic "just keep training" advice
âœ— Never lecture or preach
âœ— Never ignore their emotional state

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

-----

### MODE 5: COMPETITION MODE

```
You are Professor OS in COMPETITION MODE.

The user has activated Competition Mode by setting a competition date. Your job is to provide structured preparation guidance leading up to the competition.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
COMPETITION MODE WORKFLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**PHASE 1: ACTIVATION (Competition announced)**

When user says "I'm competing in X weeks":

1. GATHER COMPETITION DETAILS:
   - Date & location
   - Gi or no-gi?
   - Experience level (first comp, experienced, etc.)
   - Weight class
   - Any specific goals? (win/learn/test yourself)

2. ANALYZE CURRENT READINESS:
   - Review their training history (last 8-12 weeks)
   - Identify their A-game (highest success techniques)
   - Identify critical gaps (recurring struggles)
   - Assess training volume consistency

3. BUILD GAMEPLAN:
   - Starting strategy (pull guard? takedown? sit to guard?)
   - Primary attack sequence (their best techniques)
   - Backup options (when A-game fails)
   - Positions to AVOID (their weaknesses)
   - Weekly focus areas (what to drill each week)

**PHASE 2: WEEKLY CHECK-INS (Leading up to comp)**

Every week, check in on:
- How is drilling going? (are they doing the work?)
- How are they feeling? (confidence, nerves, preparation)
- Any adjustments needed? (injuries, struggles, etc.)
- Countdown reminder ("3 weeks outâ€”time to sharpen your A-game")

**PHASE 3: FINAL WEEK (Competition week)**

- Taper intensity (light drilling, no hard sparring)
- Mental preparation (visualize gameplan)
- Logistics reminder (weigh-in, what to bring)
- Weight management check (if relevant)
- Final gameplan review

**PHASE 4: POST-COMPETITION DEBRIEF**

After competition:
- What happened? (win/loss/how it went)
- What worked? (techniques that succeeded)
- What didn't work? (what to improve)
- How did they feel? (emotional experience)
- Lessons learned & next steps

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
COMPETITION GAMEPLAN FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

When creating initial gameplan:

**ðŸ¥‹ COMPETITION GAMEPLAN**

**Your A-Game (What's Working):**
- [Primary position]: [Technique] - You've hit this [X times] with [High/Extremely High] success
- [Backup technique]: [Details]

**Strategy:**
**Opening:** [Pull guard/takedown/sit to guard - based on their strengths]
**Primary Attack:** [Their best technique sequence]
**If That Fails:** [Backup plan]
**Positions to Avoid:** [Their known weaknesses]

**Strengths:**
- [List 2-3 things they do well]

**Critical Gaps:**
- [List 1-2 things that could cost them]

**Preparation Focus (Week by Week):**

**Weeks [X-Y]: Build Phase**
- Drill A-game sequence 20+ reps per session
- Fix critical gap: [specific weakness]
- Get 2-3 competition-pace rounds per session

**Weeks [X-Y]: Sharpening Phase**
- Competition-style sparring (start standing, 5-6 min rounds)
- Gameplan-only sparring (only use your planned strategy)
- Mental rehearsal (visualize your gameplan)

**Final Week: Taper**
- Light drilling only
- No hard sparring (don't get injured)
- Review gameplan mentally
- Confidence-building rounds with lower belts

**Competition Day Checklist:**
- Warm up 15-20 min before your division
- Visualize your opening move
- First 30 seconds: Execute the plan (don't panic, don't freeze)
- Trust your training

**You're ready. Stick to the plan.**

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
WEEKLY CHECK-IN FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**[X] Weeks to Competition**

How's your prep going?

**This week's focus:**
- [Specific drilling priority]
- [Training volume target]
- [Mental prep guidance]

**Quick check:**
- Are you drilling your A-game sequence daily?
- Any injuries or concerns?
- Feeling confident or nervous?

Tell me how training went this week.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FINAL WEEK GUIDANCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**Competition Week - Final Prep**

**This week: TAPER**

**Monday-Tuesday:**
- Light drilling (50% intensity)
- Review gameplan mentally
- No hard sparring

**Wednesday-Thursday:**
- Technique polish only (perfect your entries)
- Light positional sparring with lower belts (build confidence)
- Visualize your first 30 seconds

**Friday (Day before):**
- REST or very light movement
- Mental rehearsal (run through gameplan 5x in your head)
- Check weight if needed

**Saturday (Competition day):**
- Warm up 15-20 min before your division
- First move: [specific opening from gameplan]
- Trust your training

**You've prepared. Now execute.**

Questions or concerns?

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
POST-COMPETITION DEBRIEF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

After they compete:

**Competition Debrief**

How'd it go?

**Tell me:**
- Win or loss?
- What happened? (brief summary)
- What worked from your gameplan?
- What didn't work?
- How did you feel?

**Then I'll give you:**
- Analysis of what to keep/change
- Lessons learned
- Next training focus
- Encouragement (win or lossâ€”competing takes courage)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
COMPETITION MODE TONE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- **Directive but supportive** - you're the coach now, give clear guidance
- **Confident** - project confidence in their preparation
- **Realistic** - don't promise wins, prepare them for the reality
- **Structured** - clear weekly plans, specific drilling priorities
- **Accountability** - check if they're doing the work

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CRITICAL RULES FOR COMPETITION MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Always base gameplan on THEIR actual strengths (not generic advice)
âœ“ Identify and fix ONE critical gap before competition
âœ“ Taper intensity final week (prevent injuries)
âœ“ Check in weekly with structured guidance
âœ“ Post-comp debrief is mandatory (learn from experience)
âœ“ Celebrate competing regardless of outcome (it takes courage)

âœ— Never promise they'll win (realistic expectations)
âœ— Never give generic competition advice (personalize to their game)
âœ— Never let them overtrain final week (taper is critical)
âœ— Never skip the post-comp debrief (learning opportunity)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
WEIGHT MANAGEMENT INTEGRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

If user mentions needing to cut weight:

**Ask:**
- Current weight?
- Competition weight class?
- How much to lose?
- How many weeks out?

**If cut is > 10 lbs with < 4 weeks:**
"That's an aggressive cut. We can do it, but we need to be smart and safe about this."

**Provide:**
- Weekly weight loss targets (1-2 lbs/week is safe)
- Hydration protocols (week of competition)
- Energy management (training volume may need adjustment)
- Safety limits (never cut more than 10% body weight)

**Always include:**
"I'm not a nutritionist or doctorâ€”if you're cutting significant weight, consider consulting a professional. I can guide the training side, but weight cutting needs to be done safely."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

-----

# 3. TECHNICAL ARCHITECTURE

## System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER                                 â”‚
â”‚                   (Mobile/Web App)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FRONTEND (React)                           â”‚
â”‚  â€¢ Session logging UI                                        â”‚
â”‚  â€¢ Voice input (Web Speech API + Whisper)                   â”‚
â”‚  â€¢ Chat interface                                            â”‚
â”‚  â€¢ Dashboard & analytics                                     â”‚
â”‚  â€¢ Video player with timestamp deep links                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BACKEND (Node.js/Express)                   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           ROUTING LAYER                              â”‚  â”‚
â”‚  â”‚  â€¢ /api/sessions                                      â”‚  â”‚
â”‚  â”‚  â€¢ /api/ai/chat                                       â”‚  â”‚
â”‚  â”‚  â€¢ /api/techniques                                    â”‚  â”‚
â”‚  â”‚  â€¢ /api/videos                                        â”‚  â”‚
â”‚  â”‚  â€¢ /api/competition                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           DUAL-AI ORCHESTRATION                      â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  [User Input] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚  â”‚
â”‚  â”‚                          â”‚                            â”‚  â”‚
â”‚  â”‚                          â–¼                            â”‚  â”‚
â”‚  â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚
â”‚  â”‚                  â”‚  ROUTER       â”‚                   â”‚  â”‚
â”‚  â”‚                  â”‚  (Determine   â”‚                   â”‚  â”‚
â”‚  â”‚                  â”‚   AI Mode)    â”‚                   â”‚  â”‚
â”‚  â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚
â”‚  â”‚                          â”‚                            â”‚  â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚         â–¼                                  â–¼          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   GPT-4o    â”‚                  â”‚ CLAUDE 4     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚             â”‚                  â”‚  SONNET      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Extract   â”‚                  â”‚              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   techniquesâ”‚                  â”‚ â€¢ Coaching   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Analyze   â”‚                  â”‚ â€¢ Strategy   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   videos    â”‚                  â”‚ â€¢ Patterns   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Sequences â”‚                  â”‚ â€¢ Memory     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         VIDEO CURATION SYSTEM                        â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  YouTube API â”€â”€â†’ GPT-4o Pre-Filter â”€â”€â†’ Database     â”‚  â”‚
â”‚  â”‚       â”‚              â”‚                     â”‚          â”‚  â”‚
â”‚  â”‚       â”‚              â–¼                     â”‚          â”‚  â”‚
â”‚  â”‚       â”‚      Timestamp Analysis           â”‚          â”‚  â”‚
â”‚  â”‚       â”‚      (Transcript â†’ JSON)          â”‚          â”‚  â”‚
â”‚  â”‚       â”‚              â”‚                     â”‚          â”‚  â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DATABASE (PostgreSQL)                           â”‚
â”‚  â€¢ users                                                     â”‚
â”‚  â€¢ sessions                                                  â”‚
â”‚  â€¢ techniques                                                â”‚
â”‚  â€¢ videos                                                    â”‚
â”‚  â€¢ technique_index (timestamps)                             â”‚
â”‚  â€¢ competitions                                              â”‚
â”‚  â€¢ conversations                                             â”‚
â”‚  â€¢ subscriptions                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

-----

## Dual-AI Architecture: Why GPT-4o + Claude?

### **GPT-4o Responsibilities:**

1. **Technique extraction** from session logs (structured data)
1. **Video transcript analysis** (timestamp generation)
1. **Sequence detection** (technique chain identification)
1. **Pre-filtering videos** (quality assessment)

**Why GPT-4o here:** Fast, cheap, excellent at structured data extraction

### **Claude Sonnet 4 Responsibilities:**

1. **Coaching conversations** (all 5 modes)
1. **Pattern recognition** across sessions
1. **Strategic thinking** (competition prep, gameplan building)
1. **Contextual memory** (remembering userâ€™s journey)

**Why Claude here:** Superior reasoning, nuanced coaching, better conversation quality

-----

## AI Routing Logic

```javascript
const routeToAI = async (userInput, context) => {
  // Determine which AI to use based on task
  
  // GPT-4o tasks (structured extraction)
  if (taskType === 'extract_techniques_from_session') {
    return await gpt4o.extract({
      prompt: TECHNIQUE_EXTRACTION_PROMPT,
      input: userInput
    });
  }
  
  if (taskType === 'analyze_video_transcript') {
    return await gpt4o.analyze({
      prompt: TIMESTAMP_ANALYSIS_PROMPT,
      transcript: videoTranscript
    });
  }
  
  if (taskType === 'detect_technique_sequences') {
    return await gpt4o.extract({
      prompt: SEQUENCE_DETECTION_PROMPT,
      sessionLog: userInput
    });
  }
  
  // Claude tasks (coaching & conversation)
  if (taskType === 'post_session_coaching') {
    return await claude.messages.create({
      model: "claude-sonnet-4-20250514",
      max_tokens: 2000,
      system: POST_SESSION_COACHING_PROMPT,
      messages: buildConversationHistory(context)
    });
  }
  
  if (taskType === 'pre_training_focus') {
    return await claude.messages.create({
      model: "claude-sonnet-4-20250514",
      max_tokens: 1500,
      system: PRE_TRAINING_FOCUS_PROMPT,
      messages: buildConversationHistory(context)
    });
  }
  
  // Default: Claude for all conversation
  return await claude.messages.create({
    model: "claude-sonnet-4-20250514",
    max_tokens: 2000,
    system: determineSystemPrompt(context),
    messages: buildConversationHistory(context)
  });
};
```

-----

## Multilingual Processing (Portuguese â†” English)

### **The Challenge:**

- Most elite BJJ instruction is in **English** (Danaher, Gordon, Lachlan, etc.)
- 30-40% of BJJ practitioners are **Brazilian** (Portuguese-speaking)
- Need seamless translation without losing technical nuance

### **The Solution:**

```javascript
const multilingualPipeline = {
  // Detect user's language
  detectLanguage: async (userInput) => {
    // Claude can detect language naturally
    const detection = await claude.detect(userInput);
    return detection.language; // 'en' or 'pt'
  },
  
  // Process session in user's language
  processSession: async (userInput, userLanguage) => {
    let processedText = userInput;
    
    // If Portuguese, translate to English for processing
    if (userLanguage === 'pt') {
      processedText = await translateToEnglish(userInput);
    }
    
    // Extract techniques (GPT-4o works in English)
    const techniques = await gpt4o.extract({
      prompt: TECHNIQUE_EXTRACTION_PROMPT,
      input: processedText
    });
    
    // Save to database (always in English for consistency)
    await db.sessions.create({
      user_id: userId,
      original_text: userInput,
      original_language: userLanguage,
      processed_text: processedText,
      techniques_extracted: techniques
    });
    
    // Generate coaching response (Claude in English)
    const coachingResponse = await claude.coach(processedText, context);
    
    // Translate response back to Portuguese if needed
    if (userLanguage === 'pt') {
      return await translateToPortuguese(coachingResponse);
    }
    
    return coachingResponse;
  },
  
  // Translation service
  translate: async (text, fromLang, toLang) => {
    // Use Claude for translation (better than Google Translate for technical terms)
    return await claude.messages.create({
      model: "claude-sonnet-4-20250514",
      max_tokens: 4000,
      system: `You are a BJJ translator. Translate this text from ${fromLang} to ${toLang}.
      
      CRITICAL: Preserve all technical BJJ terminology accurately.
      
      Common terms:
      - "closed guard" = "guarda fechada"
      - "triangle" = "triÃ¢ngulo"
      - "arm bar" = "chave de braÃ§o"
      - "mount" = "montada"
      - "side control" = "cem quilos" or "controle lateral"
      - "back control" = "pegada nas costas"
      
      Maintain the coaching tone and style. Do not just translate wordsâ€”translate meaning and intent.`,
      messages: [{ role: "user", content: text }]
    });
  }
};
```

### **Video Recommendations for Portuguese Speakers:**

```javascript
const recommendVideos = async (technique, userLanguage) => {
  // Search for videos in user's language first
  const videos = await db.videos.search({
    technique: technique,
    language: userLanguage
  });
  
  // If Portuguese and no Portuguese videos found, recommend English with note
  if (userLanguage === 'pt' && videos.length === 0) {
    const englishVideos = await db.videos.search({
      technique: technique,
      language: 'en'
    });
    
    return {
      videos: englishVideos,
      note: "Estes vÃ­deos estÃ£o em inglÃªs, mas a demonstraÃ§Ã£o visual Ã© clara. As legendas automÃ¡ticas do YouTube podem ajudar."
    };
  }
  
  return { videos, note: null };
};
```

-----

# 4. DATABASE SCHEMA

## Complete PostgreSQL Schema

```sql
-- =====================================================
-- USERS & AUTHENTICATION
-- =====================================================

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Authentication (Clerk integration)
  clerk_user_id TEXT UNIQUE NOT NULL,
  email TEXT UNIQUE NOT NULL,
  name TEXT,
  
  -- Timestamps
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  last_seen TIMESTAMP DEFAULT NOW(),
  
  -- Profile (from onboarding)
  belt_level TEXT NOT NULL CHECK (belt_level IN ('white', 'blue', 'purple', 'brown', 'black')),
  years_training DECIMAL(3,1), -- e.g., 2.5 years
  training_frequency INTEGER, -- sessions per week goal
  training_style TEXT CHECK (training_style IN ('gi', 'nogi', 'both')),
  main_goal TEXT CHECK (main_goal IN ('get_better', 'compete', 'fitness', 'fun', 'self_defense')),
  
  -- Physical attributes (for personalization)
  height_cm INTEGER,
  weight_kg DECIMAL(5,2),
  age INTEGER,
  body_type TEXT, -- 'stocky', 'athletic', 'tall_lanky'
  
  -- Language preference
  preferred_language TEXT DEFAULT 'en' CHECK (preferred_language IN ('en', 'pt')),
  
  -- Subscription
  subscription_tier TEXT DEFAULT 'free' NOT NULL CHECK (subscription_tier IN ('free', 'pro')),
  stripe_customer_id TEXT,
  subscription_status TEXT CHECK (subscription_status IN ('active', 'past_due', 'canceled', 'trialing')),
  subscription_start_date DATE,
  subscription_end_date DATE,
  
  -- Cached statistics (updated on session create)
  total_sessions INTEGER DEFAULT 0,
  total_hours DECIMAL(6,2) DEFAULT 0,
  total_techniques_saved INTEGER DEFAULT 0,
  current_streak_days INTEGER DEFAULT 0,
  longest_streak_days INTEGER DEFAULT 0,
  last_session_date DATE,
  
  -- AI quota tracking (reset monthly for free tier)
  ai_sessions_this_month INTEGER DEFAULT 0,
  quota_reset_date DATE,
  
  -- Settings
  timezone TEXT DEFAULT 'UTC',
  notification_enabled BOOLEAN DEFAULT true,
  
  -- Injury tracking
  active_injuries TEXT[], -- ['shoulder', 'knee']
  injury_notes JSONB -- [{ body_part: 'shoulder', mentioned_date: '2025-01-15', severity: 'minor' }]
);

CREATE INDEX idx_users_clerk ON users(clerk_user_id);
CREATE INDEX idx_users_email ON users(email);

-- =====================================================
-- TRAINING SESSIONS
-- =====================================================

CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  
  -- Session metadata
  session_date DATE NOT NULL,
  session_time TIME,
  created_at TIMESTAMP DEFAULT NOW(),
  
  -- Session details
  duration_minutes INTEGER,
  gym_name TEXT,
  training_type TEXT CHECK (training_type IN ('drilling', 'sparring', 'both', 'technique', 'open_mat', 'competition_class')),
  gi_or_nogi TEXT CHECK (gi_or_nogi IN ('gi', 'nogi', 'both')),
  
  -- Original user input
  original_text TEXT NOT NULL, -- What user typed/said
  original_language TEXT DEFAULT 'en',
  processed_text TEXT, -- English translation if needed
  
  -- Voice recording metadata (if voice input)
  voice_recording_url TEXT,
  voice_duration_seconds INTEGER,
  
  -- Extracted structured data (via GPT-4o)
  techniques_practiced TEXT[], -- ['triangle', 'armbar', 'guard_passing']
  techniques_hit_in_sparring TEXT[], -- ['triangle', 'back_take']
  positions_worked TEXT[], -- ['closed_guard', 'half_guard', 'mount']
  submissions_received TEXT[], -- ['armbar', 'triangle']
  
  -- Training partners mentioned
  partners_mentioned TEXT[], -- ['Alex', 'Mike', 'Sarah']
  
  -- Opponent characteristics (for pattern analysis)
  opponent_types JSONB, -- [{ type: 'bigger', notes: 'struggled' }, { type: 'wrestler', notes: 'got taken down' }]
  
  -- Mood & energy
  energy_level INTEGER CHECK (energy_level BETWEEN 1 AND 10),
  mood TEXT CHECK (mood IN ('great', 'good', 'okay', 'frustrated', 'tired')),
  
  -- Notes & struggles
  struggles_mentioned TEXT[], -- ['getting passed from half guard', 'timing issues']
  wins_mentioned TEXT[], -- ['hit first triangle', 'defended back take']
  notes TEXT, -- Additional notes
  
  -- AI coaching response
  coaching_response TEXT,
  coaching_mode TEXT CHECK (coaching_mode IN ('post_session', 'pre_training', 'general'))
);

CREATE INDEX idx_sessions_user ON sessions(user_id);
CREATE INDEX idx_sessions_date ON sessions(user_id, session_date DESC);
CREATE INDEX idx_sessions_techniques ON sessions USING GIN(techniques_practiced);

-- =====================================================
-- TECHNIQUES LIBRARY (User's saved techniques)
-- =====================================================

CREATE TABLE techniques (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  
  -- Technique identification
  technique_name TEXT NOT NULL, -- 'Triangle from Closed Guard'
  position_category TEXT, -- 'closed_guard', 'mount', 'back', 'half_guard'
  submission_type TEXT, -- 'choke', 'armlock', 'leglock', 'none'
  
  -- When saved
  created_at TIMESTAMP DEFAULT NOW(),
  last_reviewed TIMESTAMP,
  
  -- User's notes
  user_notes TEXT,
  
  -- AI-generated details (from Claude)
  ai_generated_details TEXT, -- Multi-instructor breakdown
  key_instructors TEXT[], -- ['Roger Gracie', 'John Danaher']
  
  -- Performance tracking
  times_drilled INTEGER DEFAULT 0,
  times_attempted_in_sparring INTEGER DEFAULT 0,
  times_successful_in_sparring INTEGER DEFAULT 0,
  success_rate DECIMAL(3,2), -- Calculated: successful/attempted
  
  -- Last updated by session
  last_drilled_session_id UUID REFERENCES sessions(id),
  last_attempted_session_id UUID REFERENCES sessions(id),
  
  -- Associated videos
  video_ids UUID[] -- References to videos table
);

CREATE INDEX idx_techniques_user ON techniques(user_id);
CREATE INDEX idx_techniques_name ON techniques(technique_name);
CREATE INDEX idx_techniques_category ON techniques(position_category);

-- =====================================================
-- VIDEO LIBRARY (Curated instructional videos)
-- =====================================================

CREATE TABLE videos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- YouTube metadata
  video_id TEXT UNIQUE NOT NULL, -- YouTube video ID (e.g., 'dQw4w9WgXcQ')
  title TEXT NOT NULL,
  channel_name TEXT,
  instructor TEXT, -- 'John Danaher', 'Lachlan Giles', etc.
  
  -- Video details
  upload_date DATE,
  total_duration INTEGER, -- seconds
  view_count INTEGER,
  thumbnail_url TEXT,
  
  -- Quality assessment (from GPT-4o)
  quality_score DECIMAL(3,1) CHECK (quality_score BETWEEN 1 AND 10),
  quality_reasoning TEXT,
  
  -- Metadata
  language TEXT DEFAULT 'en',
  gi_or_nogi TEXT CHECK (gi_or_nogi IN ('gi', 'nogi', 'both')),
  difficulty TEXT CHECK (difficulty IN ('beginner', 'intermediate', 'advanced')),
  
  -- Approval status
  approved BOOLEAN DEFAULT false,
  approved_at TIMESTAMP,
  approved_by TEXT, -- admin username
  
  -- User feedback (crowd-sourced quality)
  helpful_count INTEGER DEFAULT 0,
  not_helpful_count INTEGER DEFAULT 0,
  helpful_ratio DECIMAL(3,2), -- calculated: helpful / (helpful + not_helpful)
  total_feedback_count INTEGER DEFAULT 0,
  
  -- Curation metadata
  created_at TIMESTAMP DEFAULT NOW(),
  last_analyzed TIMESTAMP,
  
  -- Instructor credibility (for ranking)
  instructor_competition_record TEXT, -- 'IBJF World Champion 3x'
  instructor_credibility_score INTEGER DEFAULT 50 -- 0-100
);

CREATE INDEX idx_videos_video_id ON videos(video_id);
CREATE INDEX idx_videos_instructor ON videos(instructor);
CREATE INDEX idx_videos_approved ON videos(approved, quality_score DESC);

-- =====================================================
-- TECHNIQUE INDEX (Timestamps within videos)
-- =====================================================

CREATE TABLE technique_index (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  video_id UUID REFERENCES videos(id) ON DELETE CASCADE,
  
  -- Technique details
  technique_name TEXT NOT NULL, -- 'Triangle from Closed Guard'
  technique_name_pt TEXT, -- Portuguese translation
  
  -- Timestamps
  start_time TEXT NOT NULL, -- 'MM:SS' format (e.g., '2:15')
  end_time TEXT NOT NULL,
  start_seconds INTEGER NOT NULL, -- For URL params (e.g., 135)
  end_seconds INTEGER NOT NULL,
  duration_seconds INTEGER NOT NULL,
  
  -- Description
  description TEXT,
  description_pt TEXT, -- Portuguese translation
  
  -- Classification
  difficulty TEXT CHECK (difficulty IN ('beginner', 'intermediate', 'advanced')),
  gi_or_nogi TEXT CHECK (gi_or_nogi IN ('gi', 'nogi', 'both')),
  
  -- Searchability
  position_tags TEXT[], -- ['closed_guard', 'triangle', 'submissions']
  
  -- Key moments within this technique section
  key_moments JSONB,
  -- Example: [
  --   { "timestamp": "2:15", "detail": "Why underhook matters" },
  --   { "timestamp": "3:22", "detail": "Hand fighting sequence" }
  -- ]
  
  -- Metadata
  instructor TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_technique_index_video ON technique_index(video_id);
CREATE INDEX idx_technique_index_name ON technique_index(technique_name);
CREATE INDEX idx_technique_index_tags ON technique_index USING GIN(position_tags);

-- Full-text search
CREATE INDEX idx_technique_search ON technique_index 
  USING GIN (to_tsvector('english', technique_name || ' ' || COALESCE(description, '')));

-- =====================================================
-- TECHNIQUE SEQUENCES (For chain discovery)
-- =====================================================

CREATE TABLE technique_sequences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  session_id UUID REFERENCES sessions(id) ON DELETE CASCADE,
  
  -- Sequence data
  starting_technique TEXT NOT NULL,
  followup_technique TEXT NOT NULL,
  success BOOLEAN NOT NULL,
  
  -- Context
  position_context TEXT, -- 'bottom_half_guard', 'closed_guard'
  opponent_type TEXT, -- 'bigger', 'wrestler', 'guard_player'
  
  -- User details (for aggregation)
  user_belt_level TEXT,
  
  -- Timestamp
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_sequences_user ON technique_sequences(user_id);
CREATE INDEX idx_sequences_starting ON technique_sequences(starting_technique, success);

-- =====================================================
-- COMPETITIONS
-- =====================================================

CREATE TABLE competitions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  
  -- Competition details
  competition_date DATE NOT NULL,
  competition_name TEXT,
  location TEXT,
  
  -- Division details
  gi_or_nogi TEXT CHECK (gi_or_nogi IN ('gi', 'nogi')),
  weight_class TEXT,
  belt_division TEXT,
  
  -- User's goals
  main_goal TEXT, -- 'win', 'learn', 'test_myself'
  
  -- Gameplan (AI-generated)
  gameplan TEXT,
  a_game_techniques TEXT[], -- ['triangle', 'armbar']
  positions_to_avoid TEXT[], -- ['bottom_side_control']
  
  -- Status
  status TEXT DEFAULT 'upcoming' CHECK (status IN ('upcoming', 'completed', 'canceled')),
  
  -- Results (post-competition)
  result TEXT CHECK (result IN ('win', 'loss', 'draw', null)),
  matches_total INTEGER,
  matches_won INTEGER,
  submission_wins INTEGER,
  notes TEXT, -- Post-competition notes
  lessons_learned TEXT, -- AI-generated debrief
  
  -- Timestamps
  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP
);

CREATE INDEX idx_competitions_user ON competitions(user_id);
CREATE INDEX idx_competitions_date ON competitions(user_id, competition_date);

-- =====================================================
-- CONVERSATIONS (AI chat history)
-- =====================================================

CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  session_id UUID REFERENCES sessions(id) ON DELETE SET NULL,
  
  -- Message details
  role TEXT NOT NULL CHECK (role IN ('user', 'assistant')),
  content TEXT NOT NULL,
  
  -- AI mode
  ai_mode TEXT CHECK (ai_mode IN ('post_session', 'pre_training', 'technique_query', 'general', 'competition')),
  
  -- AI model used
  ai_model TEXT, -- 'claude-sonnet-4-20250514' or 'gpt-4o'
  
  -- Tokens (for cost tracking)
  input_tokens INTEGER,
  output_tokens INTEGER,
  
  -- Timestamp
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_conversations_user ON conversations(user_id);
CREATE INDEX idx_conversations_session ON conversations(session_id);

-- =====================================================
-- SUBSCRIPTIONS & PAYMENTS
-- =====================================================

CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  
  -- Stripe details
  stripe_subscription_id TEXT UNIQUE,
  stripe_customer_id TEXT NOT NULL,
  stripe_price_id TEXT NOT NULL,
  
  -- Subscription details
  tier TEXT NOT NULL CHECK (tier IN ('free', 'pro')),
  status TEXT NOT NULL CHECK (status IN ('active', 'past_due', 'canceled', 'trialing', 'incomplete')),
  
  -- Billing
  current_period_start TIMESTAMP,
  current_period_end TIMESTAMP,
  cancel_at_period_end BOOLEAN DEFAULT false,
  
  -- Timestamps
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_subscriptions_user ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_stripe ON subscriptions(stripe_subscription_id);

-- =====================================================
-- PAYMENT EVENTS (Stripe webhooks)
-- =====================================================

CREATE TABLE payment_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  
  -- Stripe event
  stripe_event_id TEXT UNIQUE NOT NULL,
  event_type TEXT NOT NULL,
  
  -- Event data
  amount INTEGER, -- cents
  currency TEXT,
  status TEXT,
  
  -- Raw event (for debugging)
  raw_event JSONB,
  
  -- Timestamp
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_payment_events_user ON payment_events(user_id);
CREATE INDEX idx_payment_events_stripe ON payment_events(stripe_event_id);

-- =====================================================
-- PROGRESS MILESTONES (For celebrations)
-- =====================================================

CREATE TABLE milestones (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  
  -- Milestone details
  milestone_type TEXT NOT NULL,
  -- 'sessions_10', 'sessions_50', 'hours_100', 'streak_7', 'streak_30', 
  -- 'first_submission', 'anniversary_1_year'
  
  milestone_title TEXT NOT NULL,
  milestone_message TEXT,
  
  -- When achieved
  achieved_at TIMESTAMP DEFAULT NOW(),
  
  -- Was it shared?
  shared BOOLEAN DEFAULT false,
  
  -- Associated session (if applicable)
  session_id UUID REFERENCES sessions(id) ON DELETE SET NULL
);

CREATE INDEX idx_milestones_user ON milestones(user_id);
CREATE INDEX idx_milestones_achieved ON milestones(achieved_at DESC);

-- =====================================================
-- VIDEO FEEDBACK (User ratings on videos)
-- =====================================================

CREATE TABLE video_feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  video_id UUID REFERENCES videos(id) ON DELETE CASCADE,
  technique_index_id UUID REFERENCES technique_index(id) ON DELETE CASCADE,
  
  -- Feedback
  helpful BOOLEAN NOT NULL, -- true = helpful, false = not helpful
  
  -- Optional comment
  comment TEXT,
  
  -- Timestamp
  created_at TIMESTAMP DEFAULT NOW(),
  
  -- Unique constraint: one feedback per user per video
  UNIQUE(user_id, video_id)
);

CREATE INDEX idx_video_feedback_video ON video_feedback(video_id);

-- =====================================================
-- ADMIN & SYSTEM
-- =====================================================

CREATE TABLE system_config (
  key TEXT PRIMARY KEY,
  value JSONB NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Insert default config
INSERT INTO system_config (key, value) VALUES
  ('video_curation_enabled', 'true'),
  ('youtube_api_daily_quota', '10000'),
  ('youtube_api_quota_used_today', '0'),
  ('last_curation_run', 'null');
```

-----

# 5. VIDEO CURATION & TIMESTAMPING SYSTEM

## Overview

The video curation system is the **secret weapon** that makes BJJ OS superior to competitors. Instead of a generic library of 10,000+ random videos, we curate a **targeted library of 2,000+ elite videos with precise timestamps**.

**Key features:**

1. **Trusted instructor filter** (50+ world-class black belts)
1. **AI quality scoring** (GPT-4o analyzes transcripts)
1. **Precise timestamping** (jump to exact technique)
1. **User feedback loop** (crowd-sourced quality)
1. **Gap detection** (identifies missing content)

-----

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   VIDEO CURATION PIPELINE                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PHASE 1: DISCOVERY
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  YouTube API    â”‚  Search queries for trusted instructors
â”‚  Search         â”‚  Example: "john danaher closed guard"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Initial Filter â”‚  Basic checks:
â”‚  (Quick Pass)   â”‚  â€¢ Duration > 5 min, < 60 min
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ Title contains BJJ terms
         â”‚           â€¢ Channel is trusted instructor
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Candidate DB   â”‚  Store for analysis
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         
PHASE 2: DEEP ANALYSIS
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Get Transcript â”‚  YouTube transcript API
â”‚  (If available) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GPT-4o        â”‚  Analyze transcript:
â”‚   Analysis      â”‚  â€¢ Quality score (1-10)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ Techniques taught (with timestamps)
         â”‚           â€¢ Difficulty level
         â”‚           â€¢ Gi/nogi applicability
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Timestamp Map  â”‚  Precise technique locations
â”‚  Generation     â”‚  { technique: 'triangle', start: '2:15', end: '5:47' }
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         
PHASE 3: STORAGE & INDEXING
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Quality Filter â”‚  Only save if:
â”‚                 â”‚  â€¢ Score >= 7.5
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ Has clear technique sections
         â”‚           â€¢ Instructor on trusted list
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Database      â”‚  videos + technique_index tables
â”‚   (Approved)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         
PHASE 4: USER FEEDBACK LOOP
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Watches   â”‚  Users click videos from recommendations
â”‚  & Rates        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Feedback       â”‚  Thumbs up / down
â”‚  Aggregation    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Auto Removal   â”‚  If helpful_ratio < 40% (after 20+ votes)
â”‚  or Promotion   â”‚  If helpful_ratio > 90% (after 50+ votes)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â†’ Boost ranking
```

-----

## Implementation

### **STEP 1: Trusted Instructor List**

```javascript
const TRUSTED_INSTRUCTORS = {
  // Tier 1: World Champions / Elite Competitors
  tier1: {
    credibility_score: 100,
    instructors: [
      { name: 'John Danaher', channels: ['Bernardo Faria BJJ', 'BJJ Fanatics'] },
      { name: 'Gordon Ryan', channels: ['Gordon Ryan'] },
      { name: 'Lachlan Giles', channels: ['Lachlan Giles', 'Absolute MMA'] },
      { name: 'Roger Gracie', channels: ['Roger Gracie'] },
      { name: 'Marcelo Garcia', channels: ['Marcelo Garcia', 'MGinAction'] },
      { name: 'Craig Jones', channels: ['Craig Jones', 'B-Team Jiu Jitsu'] },
      { name: 'Bernardo Faria', channels: ['Bernardo Faria BJJ'] },
      { name: 'Lucas Lepri', channels: ['Lucas Lepri'] },
      { name: 'Caio Terra', channels: ['Caio Terra'] },
      { name: 'Tainan Dalpra', channels: ['Tainan Dalpra'] },
      { name: 'Mikey Musumeci', channels: ['Mikey Musumeci'] },
      { name: 'Keenan Cornelius', channels: ['Keenan Online'] },
      { name: 'AndrÃ© GalvÃ£o', channels: ['Atos Jiu-Jitsu'] },
      { name: 'Leandro Lo', channels: ['Leandro Lo'] },
      { name: 'Buchecha', channels: ['Marcus Buchecha'] },
    ]
  },
  
  // Tier 2: High-Level Black Belts / Great Teachers
  tier2: {
    credibility_score: 85,
    instructors: [
      { name: 'Priit Mihkelson', channels: ['Priit Mihkelson'] },
      { name: 'Jon Thomas', channels: ['The Grappling Academy'] },
      { name: 'Kama Jiu-Jitsu', channels: ['Kama Jiu-Jitsu'] },
      { name: 'Chewjitsu', channels: ['Chewjitsu'] },
      { name: 'Stephan Kesting', channels: ['Grapplearts'] },
      { name: 'Rob Biernacki', channels: ['Island Top Team'] },
      { name: 'Paul Schreiner', channels: ['Paul Schreiner BJJ'] },
      { name: 'Ryan Hall', channels: ['Ryan Hall'] },
      { name: 'Xande Ribeiro', channels: ['Xande Ribeiro'] },
      { name: 'Saulo Ribeiro', channels: ['Saulo Ribeiro'] },
    ]
  },
  
  // Tier 3: Solid Instructors (require higher quality threshold)
  tier3: {
    credibility_score: 70,
    quality_threshold: 8.0, // Higher bar for inclusion
    instructors: [
      { name: 'BJJ Fanatics', channels: ['BJJ Fanatics'] },
      { name: 'FloGrappling', channels: ['FloGrappling'] },
      { name: 'Gracie Breakdown', channels: ['Gracie Breakdown'] },
      { name: 'Gracie University', channels: ['Gracie University'] },
    ]
  }
};
```

-----

### **STEP 2: Video Discovery (YouTube API)**

```javascript
const discoverVideos = async () => {
  const queries = generateSearchQueries();
  // Example queries:
  // "john danaher closed guard"
  // "lachlan giles half guard"
  // "gordon ryan back attacks"
  // "roger gracie mount attacks"
  
  for (const query of queries) {
    try {
      // YouTube Data API v3
      const response = await youtube.search.list({
        part: 'snippet',
        q: query,
        type: 'video',
        videoDuration: 'medium', // 4-20 minutes
        maxResults: 50,
        order: 'relevance',
        relevanceLanguage: 'en'
      });
      
      for (const video of response.data.items) {
        // Quick filter
        const passesInitialFilter = await quickFilter(video);
        
        if (passesInitialFilter) {
          // Save to candidates table
          await db.video_candidates.create({
            video_id: video.id.videoId,
            title: video.snippet.title,
            channel: video.snippet.channelTitle,
            published_at: video.snippet.publishedAt,
            status: 'pending_analysis'
          });
        }
      }
      
    } catch (error) {
      console.error('YouTube API error:', error);
    }
  }
};

const quickFilter = (video) => {
  const title = video.snippet.title.toLowerCase();
  const channel = video.snippet.channelTitle.toLowerCase();
  
  // Must contain BJJ-related terms
  const bjjTerms = ['bjj', 'jiu jitsu', 'jiu-jitsu', 'grappling', 'submission'];
  const hasBJJTerm = bjjTerms.some(term => title.includes(term));
  
  // Must NOT be competition footage (we want instruction)
  const competitionTerms = ['highlights', 'vs', 'match', 'tournament'];
  const isCompetition = competitionTerms.some(term => title.includes(term));
  
  // Check if channel is trusted
  const isTrustedChannel = Object.values(TRUSTED_INSTRUCTORS)
    .flatMap(tier => tier.instructors)
    .flatMap(inst => inst.channels)
    .some(chan => channel.includes(chan.toLowerCase()));
  
  return hasBJJTerm && !isCompetition && isTrustedChannel;
};
```

-----

### **STEP 3: Deep Analysis with GPT-4o**

```javascript
const analyzeVideo = async (videoId) => {
  // 1. Get video transcript
  const transcript = await getYouTubeTranscript(videoId);
  
  if (!transcript) {
    // No transcript available - skip this video
    await db.video_candidates.update(videoId, { 
      status: 'rejected', 
      rejection_reason: 'no_transcript' 
    });
    return null;
  }
  
  // 2. Analyze with GPT-4o
  const analysis = await openai.chat.completions.create({
    model: 'gpt-4o',
    temperature: 0.3, // Low temperature for consistent analysis
    messages: [
      {
        role: 'system',
        content: TIMESTAMP_ANALYSIS_PROMPT // See below
      },
      {
        role: 'user',
        content: `Analyze this BJJ instructional video.

Video Title: ${video.title}
Instructor: ${video.instructor}
Duration: ${video.duration}

Transcript:
${transcript}

Return analysis as JSON.`
      }
    ],
    response_format: { type: 'json_object' }
  });
  
  const result = JSON.parse(analysis.choices[0].message.content);
  
  // 3. Save to database if quality passes threshold
  if (result.quality_score >= 7.5) {
    await saveApprovedVideo(videoId, result);
  } else {
    await db.video_candidates.update(videoId, {
      status: 'rejected',
      rejection_reason: 'quality_too_low',
      quality_score: result.quality_score
    });
  }
  
  return result;
};
```

-----

### **TIMESTAMP ANALYSIS PROMPT (GPT-4o)**

```javascript
const TIMESTAMP_ANALYSIS_PROMPT = `You are an expert BJJ video analyst. Your job is to analyze instructional videos and create precise timestamp maps.

TASK: Analyze the video transcript and extract:
1. Overall quality assessment (1-10 scale)
2. Every technique taught (with precise timestamps)
3. Key details within each technique
4. Common mistakes section (if present)
5. Difficulty level for each technique
6. Gi/Nogi/Both applicability

QUALITY SCORING CRITERIA (1-10):

10 = Perfect instruction
â€¢ Crystal clear demonstration
â€¢ Step-by-step breakdown
â€¢ Common mistakes addressed
â€¢ Multiple angles/repetitions
â€¢ Instructor is world-class (Danaher, Lachlan, Roger, etc.)

8-9 = Excellent instruction
â€¢ Very clear teaching
â€¢ Good detail level
â€¢ Addresses some mistakes
â€¢ Instructor is high-level black belt

6-7 = Good instruction
â€¢ Clear enough to learn
â€¢ Decent detail
â€¢ May lack some depth

4-5 = Mediocre
â€¢ Some value but not great
â€¢ Unclear in places
â€¢ Missing key details

1-3 = Poor
â€¢ Confusing instruction
â€¢ Incomplete techniques
â€¢ Low production quality
â€¢ Not actually instructional (just competition footage)

REJECTION CRITERIA (Score < 7.5):
â€¢ Video is competition footage without instruction
â€¢ Technique explanation is unclear or incomplete
â€¢ Audio/video quality too poor to understand
â€¢ Instructor is not credible (unknown, low-level, or incorrect technique)
â€¢ Too much fluff/talking, not enough technique
â€¢ Clickbait title but no real content

TIMESTAMP FORMAT:
â€¢ Use MM:SS format (e.g., "2:15" for 2 minutes 15 seconds)
â€¢ Be PRECISE - timestamps must match the actual moment in video
â€¢ Extract start_time and end_time for each technique section
â€¢ Note key moments WITHIN each technique section

TECHNIQUE NAMING:
â€¢ Be specific: "Triangle from Closed Guard" not just "Triangle"
â€¢ Use standard BJJ terminology
â€¢ Include position context: "Mount Escape via Elbow Escape"

DIFFICULTY LEVELS:
â€¢ beginner = White/Blue belt appropriate (fundamental techniques)
â€¢ intermediate = Blue/Purple belt (more complex setups, combinations)
â€¢ advanced = Purple+ (competition-level details, advanced systems)

RETURN THIS EXACT JSON STRUCTURE:
{
  "video_id": "YouTube video ID",
  "title": "Video title",
  "instructor": "Instructor name",
  "total_duration": "MM:SS",
  
  "quality_score": 1-10,
  "quality_reasoning": "2-3 sentence explanation of score",
  
  "is_instructional": true/false,
  "rejection_reason": "If quality_score < 7.5, explain why",
  
  "techniques": [
    {
      "technique_name": "Specific technique name",
      "technique_name_pt": "Portuguese translation",
      "start_time": "MM:SS",
      "end_time": "MM:SS",
      "description": "One sentence what this section teaches",
      "description_pt": "Portuguese translation",
      
      "key_details": [
        {
          "timestamp": "MM:SS",
          "detail": "Specific insight at this moment"
        }
      ],
      
      "difficulty": "beginner|intermediate|advanced",
      "gi_or_nogi": "gi|nogi|both",
      "position_tags": ["closed_guard", "triangle", "submissions"]
    }
  ],
  
  "common_mistakes": {
    "present": true/false,
    "start_time": "MM:SS",
    "end_time": "MM:SS",
    "mistakes_covered": ["mistake 1", "mistake 2"]
  },
  
  "language": "en|pt",
  "production_quality": "high|medium|low"
}

CRITICAL RULES:
â€¢ Timestamps must be PRECISE (to the second)
â€¢ Every technique needs clear start and end time
â€¢ Quality score must be honest (don't inflate scores)
â€¢ If video is not instructional, score it 1-3
â€¢ Include Portuguese translations for technique names and descriptions
â€¢ Position tags should use standard BJJ terminology (lowercase, underscores)

EXAMPLE OUTPUT:
{
  "video_id": "abc123",
  "title": "Lachlan Giles - Half Guard Retention Fundamentals",
  "instructor": "Lachlan Giles",
  "total_duration": "14:32",
  "quality_score": 9.5,
  "quality_reasoning": "Extremely clear instruction from world-class instructor. Step-by-step breakdown with common mistakes addressed. Multiple camera angles. Perfect for blue belts.",
  "is_instructional": true,
  "techniques": [
    {
      "technique_name": "Half Guard Knee Shield Retention",
      "technique_name_pt": "RetenÃ§Ã£o de Meia Guarda com Knee Shield",
      "start_time": "2:15",
      "end_time": "5:47",
      "description": "Using knee shield frames to prevent passing from bottom half guard",
      "description_pt": "Usando o knee shield para prevenir a passagem da meia guarda por baixo",
      "key_details": [
        {
          "timestamp": "2:15",
          "detail": "Why knee shield is critical for half guard retention"
        },
        {
          "timestamp": "3:22",
          "detail": "Adjusting distance with frames - closer vs farther"
        },
        {
          "timestamp": "4:45",
          "detail": "Common mistake: letting opponent flatten the knee shield"
        }
      ],
      "difficulty": "beginner",
      "gi_or_nogi": "both",
      "position_tags": ["half_guard", "guard_retention", "defensive"]
    }
  ],
  "common_mistakes": {
    "present": true,
    "start_time": "12:15",
    "end_time": "13:50",
    "mistakes_covered": [
      "Not maintaining distance with frames",
      "Letting knee shield get flattened"
    ]
  },
  "language": "en",
  "production_quality": "high"
}`;
```

-----

### **STEP 4: Save to Database**

```javascript
const saveApprovedVideo = async (videoId, analysis) => {
  // Calculate instructor credibility
  const instructorTier = findInstructorTier(analysis.instructor);
  const credibilityScore = instructorTier?.credibility_score || 50;
  
  // 1. Save to videos table
  const video = await db.videos.create({
    video_id: videoId,
    title: analysis.title,
    instructor: analysis.instructor,
    total_duration: parseDuration(analysis.total_duration),
    quality_score: analysis.quality_score,
    quality_reasoning: analysis.quality_reasoning,
    language: analysis.language,
    difficulty: analysis.techniques[0]?.difficulty || 'intermediate',
    instructor_credibility_score: credibilityScore,
    approved: true,
    approved_at: new Date()
  });
  
  // 2. Save each technique to technique_index
  for (const technique of analysis.techniques) {
    const startSeconds = timeToSeconds(technique.start_time);
    const endSeconds = timeToSeconds(technique.end_time);
    
    await db.technique_index.create({
      video_id: video.id,
      technique_name: technique.technique_name,
      technique_name_pt: technique.technique_name_pt,
      start_time: technique.start_time,
      end_time: technique.end_time,
      start_seconds: startSeconds,
      end_seconds: endSeconds,
      duration_seconds: endSeconds - startSeconds,
      description: technique.description,
      description_pt: technique.description_pt,
      difficulty: technique.difficulty,
      gi_or_nogi: technique.gi_or_nogi,
      position_tags: technique.position_tags,
      instructor: analysis.instructor,
      key_moments: technique.key_details
    });
  }
  
  console.log(`âœ… Approved video: ${analysis.title} (Score: ${analysis.quality_score})`);
};

const timeToSeconds = (timeString) => {
  const [minutes, seconds] = timeString.split(':').map(Number);
  return (minutes * 60) + seconds;
};
```

-----

### **STEP 5: Smart Video Recommendation (with Timestamps)**

```javascript
const recommendVideoForTechnique = async (userQuery, userProfile) => {
  // Claude understands what user wants
  const intent = await analyzeUserIntent(userQuery, userProfile);
  // Example: { technique: 'triangle from closed guard', difficulty: 'beginner', gi_or_nogi: 'gi' }
  
  // Search technique_index
  const matches = await db.technique_index.search({
    technique_name: intent.technique,
    difficulty: userProfile.belt_level, // 'beginner' for white/blue
    gi_or_nogi: userProfile.training_style // 'gi', 'nogi', or 'both'
  });
  
  // Rank by:
  // 1. Instructor credibility (world champions first)
  // 2. Video quality score
  // 3. User feedback (helpful_ratio)
  const rankedMatches = matches.sort((a, b) => {
    const scoreA = (a.instructor_credibility_score * 0.4) + 
                   (a.quality_score * 10 * 0.4) + 
                   (a.helpful_ratio * 100 * 0.2);
    const scoreB = (b.instructor_credibility_score * 0.4) + 
                   (b.quality_score * 10 * 0.4) + 
                   (b.helpful_ratio * 100 * 0.2);
    return scoreB - scoreA;
  });
  
  // Get top 3 videos
  const topVideos = rankedMatches.slice(0, 3);
  
  // Format with deep links
  return topVideos.map(video => ({
    // Deep link to exact timestamp
    url: `https://youtube.com/watch?v=${video.video_id}&t=${video.start_seconds}`,
    
    title: `${video.technique_name} - ${video.instructor}`,
    
    start_time: video.start_time,
    end_time: video.end_time,
    duration: `${Math.floor(video.duration_seconds / 60)}:${(video.duration_seconds % 60).toString().padStart(2, '0')}`,
    
    description: video.description,
    
    key_moments: video.key_moments,
    // [{ timestamp: '2:15', detail: 'Why underhook matters' }]
    
    difficulty: video.difficulty,
    instructor: video.instructor,
    quality_score: video.quality_score,
    
    why_recommended: generateWhyRecommended(video, userProfile)
  }));
};

const generateWhyRecommended = (video, userProfile) => {
  const reasons = [];
  
  if (video.instructor_credibility_score >= 90) {
    reasons.push(`${video.instructor} is a world-class instructor`);
  }
  
  if (video.quality_score >= 9.0) {
    reasons.push('Extremely detailed breakdown');
  }
  
  if (video.helpful_ratio >= 0.85) {
    reasons.push('Highly rated by users like you');
  }
  
  if (video.difficulty === 'beginner' && userProfile.belt_level === 'white') {
    reasons.push('Perfect for white belts');
  }
  
  return reasons.join('. ');
};
```

-----

### **STEP 6: User Feedback Loop**

```javascript
const recordVideoFeedback = async (userId, videoId, techniqueIndexId, helpful) => {
  // Save individual feedback
  await db.video_feedback.create({
    user_id: userId,
    video_id: videoId,
    technique_index_id: techniqueIndexId,
    helpful: helpful
  });
  
  // Update aggregated counts on videos table
  if (helpful) {
    await db.videos.increment(videoId, 'helpful_count');
  } else {
    await db.videos.increment(videoId, 'not_helpful_count');
  }
  
  await db.videos.increment(videoId, 'total_feedback_count');
  
  // Recalculate helpful_ratio
  const video = await db.videos.findById(videoId);
  const helpfulRatio = video.helpful_count / (video.helpful_count + video.not_helpful_count);
  
  await db.videos.update(videoId, { helpful_ratio: helpfulRatio });
  
  // AUTO-REMOVAL LOGIC
  if (video.total_feedback_count >= 20 && helpfulRatio < 0.40) {
    // Less than 40% helpful after 20+ votes = remove
    await db.videos.update(videoId, { 
      approved: false,
      removal_reason: 'low_helpful_ratio',
      removed_at: new Date()
    });
    
    console.log(`ðŸ—‘ï¸ Removed video ${video.title} (helpful ratio: ${helpfulRatio})`);
  }
  
  // AUTO-PROMOTION LOGIC
  if (video.total_feedback_count >= 50 && helpfulRatio >= 0.90) {
    // More than 90% helpful after 50+ votes = boost ranking
    await db.videos.update(videoId, {
      quality_score: Math.min(10, video.quality_score + 0.5) // Boost score
    });
    
    console.log(`â­ Promoted video ${video.title} (helpful ratio: ${helpfulRatio})`);
  }
};
```

-----

### **STEP 7: Gap Detection System**

```javascript
const detectContentGaps = async () => {
  // Analyze user queries that didn't return good results
  const recentQueries = await db.conversations.findAll({
    where: {
      ai_mode: 'technique_query',
      created_at: { $gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) } // Last 7 days
    }
  });
  
  // Extract techniques mentioned
  const techniquesQueried = await Promise.all(
    recentQueries.map(async (query) => {
      const analysis = await gpt4o.analyze({
        prompt: 'Extract the BJJ technique name from this query:',
        query: query.content
      });
      return analysis.technique;
    })
  );
  
  // Count frequency
  const techniqueCounts = {};
  techniquesQueried.forEach(tech => {
    techniqueCounts[tech] = (techniqueCounts[tech] || 0) + 1;
  });
  
  // Check which techniques have < 3 videos in library
  const gaps = [];
  for (const [technique, count] of Object.entries(techniqueCounts)) {
    const videoCount = await db.technique_index.count({
      where: { technique_name: { $ilike: `%${technique}%` } }
    });
    
    if (count >= 5 && videoCount < 3) {
      // 5+ users asked about this, but we have < 3 videos
      gaps.push({
        technique: technique,
        user_requests: count,
        current_videos: videoCount,
        priority: count * (3 - videoCount) // Higher = more urgent
      });
    }
  }
  
  // Sort by priority
  gaps.sort((a, b) => b.priority - a.priority);
  
  // Generate targeted search queries for top gaps
  for (const gap of gaps.slice(0, 10)) { // Top 10 gaps
    await queueVideoSearch({
      query: `${gap.technique} bjj tutorial`,
      priority: gap.priority,
      gap_fill: true
    });
  }
  
  console.log(`ðŸ” Detected ${gaps.length} content gaps`);
  console.log('Top 5 gaps:', gaps.slice(0, 5));
  
  return gaps;
};

// Run gap detection weekly
setInterval(detectContentGaps, 7 * 24 * 60 * 60 * 1000);
```

-----

### **CURATION SCHEDULE**

```javascript
const VIDEO_CURATION_SCHEDULE = {
  // Initial population (first 2 weeks)
  initial: {
    target: 2000, // videos
    queries_per_day: 50,
    analysis_per_day: 100
  },
  
  // Ongoing maintenance
  ongoing: {
    new_videos_per_week: 50,
    gap_detection_frequency: 'weekly',
    quality_review_frequency: 'monthly'
  },
  
  // YouTube API quota management
  youtube_api: {
    daily_quota: 10000,
    cost_per_search: 100, // quota units
    cost_per_video_details: 1,
    max_searches_per_day: 90 // Leave buffer for other requests
  }
};

// Quota tracking
const checkYouTubeQuota = async () => {
  const config = await db.system_config.get('youtube_api_quota_used_today');
  const quotaUsed = parseInt(config.value);
  const quotaRemaining = 10000 - quotaUsed;
  
  if (quotaRemaining < 1000) {
    console.warn('âš ï¸ YouTube API quota running low');
    return false; // Pause curation
  }
  
  return true; // Continue
};
```

-----

# 6. FEATURE SPECIFICATIONS (9 Launch Features)

## Feature 1: Injury Awareness (Simple)

**What:** Track injury mentions and offer to adjust recommendations  
**Why:** Shows AI cares about user health, prevents chronic injuries  
**Dev Time:** 4-6 hours

### Implementation:

```javascript
// In session processing (GPT-4o extraction)
const extractInjuries = async (sessionText) => {
  const analysis = await gpt4o.analyze({
    prompt: `Extract any injury or pain mentions from this training log.

Session log: "${sessionText}"

Look for:
- Body parts mentioned with pain/discomfort (shoulder, knee, back, neck, etc.)
- Descriptions of soreness, pain, or injury
- Avoiding certain positions due to discomfort

Return JSON:
{
  "injuries_mentioned": [
    { "body_part": "shoulder", "severity": "minor|moderate|severe", "context": "brief context" }
  ]
}`,
    text: sessionText
  });
  
  return analysis.injuries_mentioned;
};

// Save to user profile
const trackInjury = async (userId, injury) => {
  // Add to active_injuries array
  await db.users.update(userId, {
    active_injuries: db.raw('array_append(active_injuries, ?)', [injury.body_part]),
    injury_notes: db.raw('jsonb_insert(injury_notes, \'{0}\', ?::jsonb)', [
      JSON.stringify({
        body_part: injury.body_part,
        mentioned_date: new Date(),
        severity: injury.severity,
        context: injury.context
      })
    ])
  });
  
  // Check if this is recurring (mentioned 3+ times)
  const injuryHistory = await db.users.getInjuryHistory(userId, injury.body_part);
  
  if (injuryHistory.length >= 3) {
    // Trigger caring intervention
    return {
      alert: true,
      message: `I noticed you've mentioned your ${injury.body_part} a few times recently. Want me to avoid recommending techniques that stress the ${injury.body_part}? Or suggest some mobility work?`
    };
  }
  
  return { alert: false };
};

// Filter video recommendations
const filterByInjuries = (videos, userInjuries) => {
  if (!userInjuries || userInjuries.length === 0) return videos;
  
  // Filter out techniques that stress injured areas
  const injuryFilters = {
    shoulder: ['arm_drag', 'kimura', 'americana', 'overhead_sweep'],
    knee: ['berimbolo', 'knee_bar', 'knee_slice', 'knee_on_belly'],
    back: ['bridge_escape', 'situp_escape', 'wrestling_shots'],
    neck: ['guillotine', 'front_headlock', 'can_opener']
  };
  
  return videos.filter(video => {
    const videoTags = video.position_tags || [];
    
    // Check if video includes techniques that stress injured areas
    const stressesInjury = userInjuries.some(injury => {
      const avoidTags = injuryFilters[injury] || [];
      return videoTags.some(tag => avoidTags.includes(tag));
    });
    
    return !stressesInjury;
  });
};
```

-----

## Feature 2: Competition Mode (Basic)

**What:** User sets competition date, gets structured gameplan and weekly check-ins  
**Why:** High-value feature for competitors, clear progression  
**Dev Time:** 2-3 days

### Implementation:

```javascript
// Activate Competition Mode
const activateCompetitionMode = async (userId, competitionData) => {
  const {
    competition_date,
    gi_or_nogi,
    experience_level,
    weight_class,
    goals
  } = competitionData;
  
  // Analyze user's readiness
  const recentSessions = await db.sessions.findRecent(userId, 12); // Last 12 weeks
  const aGame = await analyzeAGame(recentSessions);
  const gaps = await identifyGaps(recentSessions);
  
  // Calculate weeks out
  const weeksOut = Math.ceil(
    (new Date(competition_date) - new Date()) / (7 * 24 * 60 * 60 * 1000)
  );
  
  // Generate gameplan with Claude
  const gameplan = await claude.generateGameplan({
    user_profile: await db.users.findById(userId),
    weeks_out: weeksOut,
    a_game: aGame,
    critical_gaps: gaps,
    competition_details: competitionData
  });
  
  // Save competition
  const competition = await db.competitions.create({
    user_id: userId,
    competition_date,
    gi_or_nogi,
    weight_class,
    main_goal: goals,
    gameplan: gameplan.full_gameplan,
    a_game_techniques: aGame.top_techniques,
    positions_to_avoid: gaps.weak_positions,
    status: 'upcoming'
  });
  
  // Schedule weekly check-ins
  await scheduleWeeklyCheckIns(userId, competition.id, weeksOut);
  
  return {
    competition_id: competition.id,
    gameplan: gameplan.formatted_response
  };
};

// Analyze A-game (best techniques)
const analyzeAGame = async (sessions) => {
  // Extract all successful techniques
  const successfulTechniques = {};
  
  sessions.forEach(session => {
    session.techniques_hit_in_sparring.forEach(tech => {
      successfulTechniques[tech] = (successfulTechniques[tech] || 0) + 1;
    });
  });
  
  // Sort by frequency
  const ranked = Object.entries(successfulTechniques)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 3); // Top 3 techniques
  
  return {
    top_techniques: ranked.map(([tech, count]) => ({
      technique: tech,
      hit_count: count,
      success_level: count > 5 ? 'High' : count > 2 ? 'Moderate' : 'Low'
    }))
  };
};

// Weekly check-in notifications
const scheduleWeeklyCheckIns = async (userId, competitionId, weeksOut) => {
  for (let week = weeksOut; week > 0; week--) {
    const checkInDate = new Date();
    checkInDate.setDate(checkInDate.getDate() + ((weeksOut - week) * 7));
    
    await db.scheduled_tasks.create({
      task_type: 'competition_check_in',
      user_id: userId,
      competition_id: competitionId,
      scheduled_for: checkInDate,
      message: `${week} weeks to competition - how's your prep going?`
    });
  }
};
```

-----

## Feature 3: Progress Insights (Simple)

**What:** Weekly gentle suggestions for variety  
**Why:** Nudges users toward well-rounded training  
**Dev Time:** 4-6 hours

### Implementation:

```javascript
// Generate weekly insights
const generateWeeklyInsights = async (userId) => {
  const thisWeek = await db.sessions.getWeekSummary(userId);
  const lastMonth = await db.sessions.getMonthSummary(userId);
  
  const insights = [];
  
  // Variety check - positions
  if (thisWeek.unique_positions < 3) {
    insights.push({
      type: 'variety',
      message: `This week you focused heavily on ${thisWeek.most_practiced_position}. Want to try some ${suggestComplementaryPosition(thisWeek.most_practiced_position)} next session to stay well-rounded?`
    });
  }
  
  // New techniques
  if (lastMonth.new_techniques_saved === 0) {
    insights.push({
      type: 'learning',
      message: "You haven't saved any new techniques this month. Anything you've been working on that you want to add to your library?"
    });
  }
  
  // Training partner diversity
  if (thisWeek.unique_partners < 4) {
    insights.push({
      type: 'partners',
      message: "Try getting rounds with someone new this weekâ€”different styles challenge you in different ways."
    });
  }
  
  return insights;
};

const suggestComplementaryPosition = (position) => {
  const complements = {
    'closed_guard': 'passing work',
    'passing': 'guard retention',
    'top_control': 'bottom escapes',
    'submissions': 'positional control',
    'guard_retention': 'attacking from guard'
  };
  
  return complements[position] || 'different positions';
};
```

-----

## Feature 4: Training Variety Insights

**What:** Track partner diversity & intensity mix, suggest optimal training diet  
**Why:** Helps users balance hard/competitive/easy training  
**Dev Time:** 2-3 hours

### Implementation:

```javascript
// Analyze training variety
const analyzeTrainingVariety = async (userId) => {
  const lastMonth = await db.sessions.getMonthSummary(userId);
  
  // Analyze intensity distribution
  const intensityBreakdown = {
    challenging: 0, // getting submitted often
    competitive: 0, // back-and-forth
    confidence: 0   // dominating
  };
  
  lastMonth.sessions.forEach(session => {
    const submissionsReceived = session.submissions_received.length;
    const submissionsHit = session.techniques_hit_in_sparring.length;
    
    if (submissionsReceived > submissionsHit * 2) {
      intensityBreakdown.challenging++;
    } else if (submissionsHit > submissionsReceived * 2) {
      intensityBreakdown.confidence++;
    } else {
      intensityBreakdown.competitive++;
    }
  });
  
  // Calculate percentages
  const total = lastMonth.total_sessions;
  const percentages = {
    challenging: Math.round((intensityBreakdown.challenging / total) * 100),
    competitive: Math.round((intensityBreakdown.competitive / total) * 100),
    confidence: Math.round((intensityBreakdown.confidence / total) * 100)
  };
  
  // Optimal mix: 60% challenging, 30% competitive, 10% confidence
  const optimal = {
    challenging: 60,
    competitive: 30,
    confidence: 10
  };
  
  // Generate recommendation
  const gaps = [];
  if (percentages.challenging < 50) {
    gaps.push('Seek 2-3 more challenging rolls this week. Look for higher belts or aggressive training partners.');
  }
  if (percentages.competitive < 20) {
    gaps.push('Get more competitive rounds with people at your levelâ€”this sharpens your timing.');
  }
  if (percentages.confidence < 5) {
    gaps.push('Occasionally roll with lower belts for confidenceâ€”it's okay to work your offense.');
  }
  
  return {
    current_mix: percentages,
    optimal_mix: optimal,
    unique_partners: lastMonth.unique_partners,
    recommendations: gaps
  };
};
```

-----

## Feature 5: Simple Opponent Notes

**What:** Track patterns vs body types & styles (not specific people)  
**Why:** Foundation for Month 2 opponent analysis  
**Dev Time:** 30-45 min

### Implementation:

```javascript
// Extract opponent characteristics from session
const extractOpponentTypes = async (sessionText) => {
  const analysis = await gpt4o.analyze({
    prompt: `Extract opponent characteristics from this training log.

Session log: "${sessionText}"

Look for mentions of:
- Body types: bigger, smaller, heavier, lighter, taller, shorter, stocky, athletic
- Styles: wrestler, guard player, pressure passer, fast scrambler, technical, aggressive
- What worked / didn't work against them

Return JSON:
{
  "opponents": [
    {
      "body_type": "bigger|smaller|similar",
      "weight_difference": "approximate lbs if mentioned",
      "style": "wrestler|guard_player|pressure|fast|technical",
      "what_worked": "brief note",
      "what_didnt_work": "brief note"
    }
  ]
}`,
    text: sessionText
  });
  
  return analysis.opponents;
};

// Save opponent data
const saveOpponentData = async (userId, sessionId, opponentTypes) => {
  await db.sessions.update(sessionId, {
    opponent_types: opponentTypes
  });
  
  // For future analysis in Month 2
  console.log('Opponent data saved for future pattern analysis');
};
```

-----

## Feature 6: Personal Progress Recap

**What:** Monthly recap of userâ€™s own stats (compare to past self only)  
**Why:** Celebrates growth without peer pressure  
**Dev Time:** 30 min

### Implementation:

```javascript
// Generate monthly progress recap
const generateMonthlyRecap = async (userId) => {
  const thisMonth = await db.sessions.getMonthSummary(userId);
  const lastMonth = await db.sessions.getPreviousMonthSummary(userId);
  
  // Calculate improvements
  const improvements = [];
  
  if (thisMonth.total_sessions > lastMonth.total_sessions) {
    const increase = thisMonth.total_sessions - lastMonth.total_sessions;
    improvements.push(`You trained ${increase} more sessions this month! ðŸ“ˆ`);
  }
  
  if (thisMonth.longest_streak > lastMonth.longest_streak) {
    improvements.push(`Your longest streak increased to ${thisMonth.longest_streak} days! ðŸ”¥`);
  }
  
  if (thisMonth.new_techniques_saved > lastMonth.new_techniques_saved) {
    improvements.push(`${thisMonth.new_techniques_saved} new techniques saved this month`);
  }
  
  // Format recap
  return {
    title: "Your Progress This Month",
    
    stats: {
      sessions: thisMonth.total_sessions,
      hours: thisMonth.total_hours,
      longest_streak: thisMonth.longest_streak
    },
    
    improvements: improvements,
    
    encouragement: improvements.length > 0 
      ? "Keep building on this momentum!"
      : "Consistency is keyâ€”keep showing up!"
  };
};
```

-----

## Feature 7: Voice Input (Transcription)

**What:** Voice-to-text for session logging  
**Why:** Faster, more natural than typing  
**Dev Time:** 1-2 days (already planned)

### Implementation:

```javascript
// Frontend: Record audio
const recordVoiceSession = async () => {
  // Use Web Speech API for initial capture
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'en-US';
  recognition.continuous = true;
  
  let transcript = '';
  
  recognition.onresult = (event) => {
    for (let i = event.resultIndex; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript + ' ';
    }
  };
  
  recognition.start();
  
  // Stop after 2 minutes or user stops
  setTimeout(() => recognition.stop(), 120000);
  
  recognition.onend = async () => {
    // Send to backend for processing
    await submitVoiceSession(transcript);
  };
};

// Backend: Process voice transcript
const processVoiceSession = async (userId, transcript) => {
  // Use Whisper for better accuracy (optional upgrade)
  const refinedTranscript = await openai.audio.transcriptions.create({
    file: audioFile, // If we have audio file
    model: 'whisper-1',
    language: 'en'
  });
  
  // Process same as text session
  return await processSessionLog(userId, refinedTranscript.text);
};
```

-----

## Feature 8: Sequence Data Collection

**What:** GPT extracts technique chains from logs (invisible to user)  
**Why:** Foundation for Month 3 Chain Discovery feature  
**Dev Time:** 1-2 days

### Implementation:

```javascript
// Extract technique sequences from session
const extractSequences = async (sessionText) => {
  const analysis = await gpt4o.analyze({
    prompt: `Extract technique sequences from this training log.

Session log: "${sessionText}"

Look for technique chains/combinations where one technique leads to another.

Examples:
- "I went for triangle, it failed, so I took the back"
  â†’ Sequence: triangle (failed) â†’ back_take (success)
  
- "Hit a sweep from closed guard, passed to mount, got armbar"
  â†’ Sequence: sweep â†’ guard_pass â†’ mount â†’ armbar (all success)

Return JSON:
{
  "sequences": [
    {
      "starting_technique": "triangle",
      "starting_outcome": "failed",
      "transition": "back_take",
      "transition_outcome": "success",
      "context": "closed_guard"
    }
  ]
}`,
    text: sessionText
  });
  
  return analysis.sequences;
};

// Save sequences (for future analysis)
const saveSequences = async (userId, sessionId, sequences) => {
  for (const seq of sequences) {
    await db.technique_sequences.create({
      user_id: userId,
      session_id: sessionId,
      starting_technique: seq.starting_technique,
      followup_technique: seq.transition,
      success: seq.transition_outcome === 'success',
      position_context: seq.context,
      user_belt_level: (await db.users.findById(userId)).belt_level
    });
  }
  
  console.log(`Saved ${sequences.length} technique sequences for future analysis`);
};
```

-----

## Feature 9: Basic Progression Milestones

**What:** Celebrate 5 core milestones with simple modals  
**Why:** Creates emotional moments, builds app attachment  
**Dev Time:** 1-2 days

### Implementation:

```javascript
// Check for milestones after session save
const checkMilestones = async (userId, newSession) => {
  const user = await db.users.findById(userId);
  const milestones = [];
  
  // Milestone 1: 10 sessions
  if (user.total_sessions === 10) {
    milestones.push({
      type: 'sessions_10',
      title: '10 Sessions! ðŸŽ‰',
      message: "You've logged 10 training sessions. You're building serious consistency.",
      share_worthy: true
    });
  }
  
  // Milestone 2: 50 sessions
  if (user.total_sessions === 50) {
    milestones.push({
      type: 'sessions_50',
      title: '50 Sessions! ðŸ”¥',
      message: "50 sessions logged. This is what separates good from great.",
      share_worthy: true
    });
  }
  
  // Milestone 3: 100 hours
  if (user.total_hours >= 100 && user.total_hours < 100 + newSession.duration_minutes / 60) {
    milestones.push({
      type: 'hours_100',
      title: '100 Hours of Training! â±ï¸',
      message: "You've spent 100 hours on the mat. That's 4+ full days of your life dedicated to jiu jitsu.",
      share_worthy: true
    });
  }
  
  // Milestone 4: 7-day streak
  if (user.current_streak_days === 7) {
    milestones.push({
      type: 'streak_7',
      title: 'Week Streak! ðŸ’ª',
      message: "7 days of training in a row. Your consistency is impressive.",
      share_worthy: true
    });
  }
  
  // Milestone 5: First submission in sparring
  if (newSession.techniques_hit_in_sparring.length > 0) {
    const hasSubmission = newSession.techniques_hit_in_sparring.some(tech => 
      ['triangle', 'armbar', 'rear_naked_choke', 'guillotine', 'kimura'].includes(tech)
    );
    
    if (hasSubmission) {
      // Check if this is their first
      const previousSubs = await db.sessions.countPreviousSubmissions(userId);
      
      if (previousSubs === 0) {
        milestones.push({
          type: 'first_submission',
          title: 'First Submission! ðŸŽŠ',
          message: "You hit your first submission in live rolling. Remember this momentâ€”you've officially leveled up.",
          share_worthy: true
        });
      }
    }
  }
  
  // Save milestones
  for (const milestone of milestones) {
    await db.milestones.create({
      user_id: userId,
      milestone_type: milestone.type,
      milestone_title: milestone.title,
      milestone_message: milestone.message,
      session_id: newSession.id
    });
  }
  
  return milestones;
};

// Frontend: Display celebration modal
const showMilestoneCelebration = (milestone) => {
  // Simple modal with celebration
  return (
    <Modal>
      <h1>{milestone.title}</h1>
      <p>{milestone.message}</p>
      {milestone.share_worthy && (
        <Button onClick={() => shareMilestone(milestone)}>
          Share on Instagram
        </Button>
      )}
    </Modal>
  );
};
```

-----

# 7. API ENDPOINTS

## Complete API Structure

```javascript
// =====================================================
// AUTHENTICATION (Clerk integration)
// =====================================================

POST   /api/auth/webhook
// Clerk webhook for user creation/updates

GET    /api/users/me
// Get current user profile & stats

PATCH  /api/users/me
// Update user profile

// =====================================================
// SESSIONS
// =====================================================

POST   /api/sessions
// Create new training session
Body: {
  session_date: "2025-01-15",
  session_time: "19:00",
  duration_minutes: 90,
  gym_name: "AOJ",
  training_type: "both", // drilling, sparring, both
  gi_or_nogi: "gi",
  original_text: "Trained tonight...",
  voice_recording_url?: "...",
  energy_level?: 8,
  mood?: "good"
}

Response: {
  session_id: "uuid",
  coaching_response: "...",
  milestones?: [...]
}

GET    /api/sessions
// Get user's session history
Query params:
  ?limit=20
  &offset=0
  &start_date=2025-01-01
  &end_date=2025-01-31

GET    /api/sessions/:id
// Get specific session details

// =====================================================
// AI COACHING
// =====================================================

POST   /api/ai/chat
// Main AI endpoint (handles all modes)
Body: {
  message: "What should I drill today?",
  mode: "pre_training", // post_session, pre_training, technique_query, general, competition
  session_id?: "uuid", // If related to specific session
  context?: {
    recent_sessions: [...],
    competition_id?: "uuid"
  }
}

Response: {
  response: "...",
  videos?: [...], // If technique query
  mode: "pre_training"
}

// =====================================================
// TECHNIQUES
// =====================================================

POST   /api/techniques
// Save technique to user's library
Body: {
  technique_name: "Triangle from Closed Guard",
  position_category: "closed_guard",
  user_notes?: "...",
  video_ids?: ["uuid1", "uuid2"]
}

GET    /api/techniques
// Get user's saved techniques
Query params:
  ?position_category=closed_guard
  &search=triangle

GET    /api/techniques/:id
// Get specific technique details

PATCH  /api/techniques/:id
// Update technique (add notes, track practice)
Body: {
  user_notes?: "...",
  times_drilled?: +1,
  times_attempted?: +1,
  times_successful?: +1
}

// =====================================================
// VIDEOS
// =====================================================

GET    /api/videos/search
// Search video library
Query params:
  ?technique=triangle
  &difficulty=beginner
  &gi_or_nogi=gi
  &instructor=Lachlan Giles

GET    /api/videos/:id
// Get video details with timestamps

POST   /api/videos/:id/feedback
// User feedback on video helpfulness
Body: {
  helpful: true, // or false
  comment?: "..."
}

// =====================================================
// COMPETITION MODE
// =====================================================

POST   /api/competitions
// Activate competition mode
Body: {
  competition_date: "2025-03-15",
  gi_or_nogi: "gi",
  experience_level: "first_competition",
  weight_class: "middleweight",
  goals: "learn"
}

Response: {
  competition_id: "uuid",
  gameplan: "..."
}

GET    /api/competitions
// Get user's competitions (past & upcoming)

GET    /api/competitions/:id
// Get specific competition details

PATCH  /api/competitions/:id
// Update competition (add results, notes)
Body: {
  result?: "win",
  matches_total?: 3,
  matches_won?: 2,
  notes?: "..."
}

POST   /api/competitions/:id/debrief
// Post-competition debrief with AI

// =====================================================
// PROGRESS & STATS
// =====================================================

GET    /api/stats/dashboard
// Get dashboard stats (streak, totals, etc.)

GET    /api/stats/insights
// Get weekly/monthly insights

GET    /api/stats/milestones
// Get achieved milestones

// =====================================================
// SUBSCRIPTION & BILLING
// =====================================================

POST   /api/subscription/checkout
// Create Stripe checkout session
Body: {
  price_id: "price_xxxxx", // Stripe price ID
  success_url: "...",
  cancel_url: "..."
}

GET    /api/subscription/status
// Get current subscription status

POST   /api/subscription/portal
// Create Stripe customer portal session

POST   /api/webhooks/stripe
// Stripe webhook for payment events

// =====================================================
// SYSTEM
// =====================================================

GET    /api/health
// Health check

POST   /api/feedback
// User feedback / bug reports
```

-----

# 8. IMPLEMENTATION SEQUENCE

## Day-by-Day Build Order (10-12 Days Total)

### **DAY 1: Project Setup & Database**

**Morning:**

- [ ] Initialize Replit project
- [ ] Set up folder structure
- [ ] Install dependencies (Express, Prisma, Clerk SDK, Anthropic SDK, OpenAI SDK)
- [ ] Configure environment variables

**Afternoon:**

- [ ] Create complete Prisma schema (copy from Section 4)
- [ ] Run initial migration
- [ ] Seed database with test data
- [ ] Test database connections

**Evening:**

- [ ] Set up Clerk authentication
- [ ] Create basic Express routes structure
- [ ] Test Clerk webhook integration

-----

### **DAY 2: Core Session Logging**

**Morning:**

- [ ] Build POST /api/sessions endpoint
- [ ] Integrate GPT-4o for technique extraction
- [ ] Test technique extraction accuracy

**Afternoon:**

- [ ] Build GET /api/sessions endpoints
- [ ] Create session history view
- [ ] Test session CRUD operations

**Evening:**

- [ ] Build basic frontend session logging UI
- [ ] Test end-to-end session creation

-----

### **DAY 3: Claude Integration (Post-Session Coaching)**

**Morning:**

- [ ] Implement Claude Sonnet 4 integration
- [ ] Load POST_SESSION_COACHING_PROMPT (from Section 2)
- [ ] Build conversation history context

**Afternoon:**

- [ ] Create POST /api/ai/chat endpoint
- [ ] Test post-session coaching responses
- [ ] Tune system prompt based on testing

**Evening:**

- [ ] Build chat UI frontend
- [ ] Test complete coaching flow
- [ ] Verify coaching quality

-----

### **DAY 4: Pre-Training Focus & Technique Query Modes**

**Morning:**

- [ ] Implement PRE_TRAINING_FOCUS_PROMPT
- [ ] Build logic to analyze recent sessions
- [ ] Test pre-training recommendations

**Afternoon:**

- [ ] Implement TECHNIQUE_QUERY_PROMPT
- [ ] Build technique explanation system
- [ ] Test multi-instructor attribution

**Evening:**

- [ ] Add mode routing to /api/ai/chat
- [ ] Test all 3 AI modes
- [ ] Frontend UI for different modes

-----

### **DAY 5: Video Curation System (Phase 1)**

**Morning:**

- [ ] Set up YouTube Data API integration
- [ ] Build video discovery queries (Section 5)
- [ ] Test video search functionality

**Afternoon:**

- [ ] Implement GPT-4o video analysis
- [ ] Load TIMESTAMP_ANALYSIS_PROMPT
- [ ] Test transcript analysis

**Evening:**

- [ ] Build video approval workflow
- [ ] Seed database with 50 test videos
- [ ] Test video storage

-----

### **DAY 6: Video Timestamping & Recommendations**

**Morning:**

- [ ] Build technique_index timestamp system
- [ ] Implement deep link generation
- [ ] Test YouTube deep links

**Afternoon:**

- [ ] Build GET /api/videos/search endpoint
- [ ] Implement smart video recommendation logic
- [ ] Test video ranking algorithm

**Evening:**

- [ ] Build video player UI with timestamp links
- [ ] Test complete video recommendation flow
- [ ] Verify timestamps are accurate

-----

### **DAY 7: Launch Features (Part 1)**

**Morning:**

- [ ] Implement Injury Awareness (Feature 1)
- [ ] Test injury tracking & filtering
- [ ] Build injury notification UI

**Afternoon:**

- [ ] Implement Progress Insights (Feature 3)
- [ ] Test weekly insight generation
- [ ] Build insights display UI

**Evening:**

- [ ] Implement Training Variety Insights (Feature 4)
- [ ] Test intensity analysis
- [ ] Build variety dashboard

-----

### **DAY 8: Launch Features (Part 2)**

**Morning:**

- [ ] Implement Competition Mode (Feature 2)
- [ ] Build gameplan generation
- [ ] Test weekly check-in scheduling

**Afternoon:**

- [ ] Build competition UI (create, view, update)
- [ ] Test complete competition flow
- [ ] Verify gameplan quality

**Evening:**

- [ ] Implement Simple Opponent Notes (Feature 5)
- [ ] Test opponent characteristic extraction
- [ ] Verify data collection for Month 2

-----

### **DAY 9: Launch Features (Part 3)**

**Morning:**

- [ ] Implement Personal Progress Recap (Feature 6)
- [ ] Test monthly recap generation
- [ ] Build recap display UI

**Afternoon:**

- [ ] Implement Sequence Data Collection (Feature 8)
- [ ] Test sequence extraction
- [ ] Verify database storage

**Evening:**

- [ ] Implement Basic Progression Milestones (Feature 9)
- [ ] Build milestone celebration modals
- [ ] Test milestone triggers

-----

### **DAY 10: Voice Input & Polish**

**Morning:**

- [ ] Implement voice input (Web Speech API)
- [ ] Integrate Whisper for transcription
- [ ] Test voice-to-text accuracy

**Afternoon:**

- [ ] Build voice recording UI
- [ ] Test complete voice flow
- [ ] Polish voice UX

**Evening:**

- [ ] Add loading states everywhere
- [ ] Error handling improvements
- [ ] Mobile responsiveness check

-----

### **DAY 11: Subscription & Payments**

**Morning:**

- [ ] Set up Stripe integration
- [ ] Create subscription products/prices
- [ ] Build checkout flow

**Afternoon:**

- [ ] Implement Stripe webhooks
- [ ] Build subscription status tracking
- [ ] Test payment flow end-to-end

**Evening:**

- [ ] Build upgrade prompts UI
- [ ] Implement free tier limits
- [ ] Test quota enforcement

-----

### **DAY 12: Testing & Launch Prep**

**Morning:**

- [ ] End-to-end testing (complete user flows)
- [ ] Fix critical bugs
- [ ] Performance optimization

**Afternoon:**

- [ ] Deploy to production (Replit)
- [ ] Custom domain setup (bjjos.app)
- [ ] SSL certificate verification

**Evening:**

- [ ] Final smoke tests in production
- [ ] Invite 5 beta testers
- [ ] Monitor for issues

-----

## Post-Launch (Week 2+)

### **Week 2: Video Library Population**

- Run video curation pipeline daily
- Target: 500 videos by end of week 2
- Monitor quality scores & user feedback

### **Week 3: User Feedback & Iteration**

- Collect user feedback from beta testers
- Fix bugs & polish UX
- Tune AI prompts based on real usage

### **Week 4: Public Launch**

- Landing page optimization
- Reddit r/bjj post
- Instagram marketing
- Target: 100 users

### **Month 2: Retention Features**

- Auto-detect gym & training reminders
- Opponent Style Adaptation (full analysis)
- Enhanced video library (1000+ videos)

### **Month 3-4: Advanced Features**

- Plateau Prediction & Prevention
- Technique Chain Discovery (launch the feature)
- Peer Comparison & Benchmarking
- Video library expansion (2000+ videos)

-----

# 9. TESTING & DEPLOYMENT

## Testing Checklist

### **Unit Tests:**

```javascript
// Test technique extraction
test('GPT-4o extracts techniques correctly', async () => {
  const session = "Drilled triangles for 30 min. Hit one in sparring.";
  const result = await extractTechniques(session);
  expect(result.techniques_practiced).toContain('triangle');
});

// Test video timestamp generation
test('Timestamp analysis returns valid JSON', async () => {
  const transcript = "At 2 minutes 15 seconds, I explain the triangle setup...";
  const result = await analyzeVideoTranscript(transcript);
  expect(result.techniques[0].start_time).toBe('2:15');
});

// Test Claude coaching quality
test('Claude provides post-session coaching', async () => {
  const response = await getClaude Coaching({
    mode: 'post_session',
    session: {...}
  });
  expect(response).toContain('pattern');
  expect(response.length).toBeGreaterThan(200);
});
```

### **Integration Tests:**

- [ ] Complete user signup flow
- [ ] Session logging â†’ AI coaching â†’ video recommendation
- [ ] Competition mode activation â†’ gameplan generation â†’ weekly check-ins
- [ ] Video search â†’ timestamp deep link â†’ user feedback
- [ ] Stripe checkout â†’ webhook â†’ subscription activation

### **End-to-End Tests:**

```javascript
// Test complete user journey
test('New user can sign up, log session, get coaching', async () => {
  // 1. Sign up
  const user = await signUp({ email: 'test@example.com', ... });
  
  // 2. Onboarding
  await completeOnboarding(user.id, {
    belt_level: 'white',
    training_frequency: 3,
    main_goal: 'get_better'
  });
  
  // 3. Log first session
  const session = await logSession(user.id, {
    original_text: "First class! Learned mount escapes..."
  });
  
  // 4. Verify coaching response
  expect(session.coaching_response).toBeTruthy();
  expect(session.coaching_response).toContain('mount escape');
});
```

-----

## Deployment Configuration

### **Environment Variables (.env):**

```bash
# Database
DATABASE_URL="postgresql://..."

# Clerk Authentication
CLERK_SECRET_KEY="sk_..."
CLERK_WEBHOOK_SECRET="whsec_..."

# AI Services
ANTHROPIC_API_KEY="sk-ant-..."
OPENAI_API_KEY="sk-..."

# YouTube Data API
YOUTUBE_API_KEY="AIza..."

# Stripe
STRIPE_SECRET_KEY="sk_..."
STRIPE_WEBHOOK_SECRET="whsec_..."

# App URLs
NEXT_PUBLIC_APP_URL="https://bjjos.app"

# Feature Flags
VIDEO_CURATION_ENABLED="true"
COMPETITION_MODE_ENABLED="true"
```

-----

### **Replit Deployment:**

```toml
# .replit
run = "npm start"
entrypoint = "server/index.js"

[nix]
channel = "stable-23_11"

[deployment]
run = ["node", "server/index.js"]
deploymentTarget = "cloudrun"
```

-----

### **Custom Domain Setup:**

1. Go to Replit Deployment settings
1. Add custom domain: bjjos.app
1. Update DNS records (provided by Replit)
1. Wait for SSL certificate provisioning (~15 min)
1. Verify HTTPS works

-----

## Monitoring & Analytics

### **Error Tracking:**

```javascript
// Sentry integration
import * as Sentry from "@sentry/node";

Sentry.init({
  dsn: "https://...",
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1
});

// Catch errors
app.use(Sentry.Handlers.errorHandler());
```

### **API Cost Tracking:**

```javascript
// Track AI API costs
const logAPICall = async (service, model, inputTokens, outputTokens) => {
  const costs = {
    'claude-sonnet-4-20250514': {
      input: 0.003 / 1000,   // $3 per 1M tokens
      output: 0.015 / 1000   // $15 per 1M tokens
    },
    'gpt-4o': {
      input: 0.005 / 1000,
      output: 0.015 / 1000
    }
  };
  
  const cost = 
    (inputTokens * costs[model].input) +
    (outputTokens * costs[model].output);
  
  await db.api_costs.create({
    service,
    model,
    input_tokens: inputTokens,
    output_tokens: outputTokens,
    cost_usd: cost,
    created_at: new Date()
  });
};
```

### **User Analytics:**

```javascript
// Key metrics to track
const analytics = {
  daily_active_users: async () => {
    return await db.users.count({
      where: {
        last_seen: { $gte: new Date(Date.now() - 24 * 60 * 60 * 1000) }
      }
    });
  },
  
  average_sessions_per_user: async () => {
    return await db.sessions.aggregate({
      _avg: { sessions_count: true },
      groupBy: ['user_id']
    });
  },
  
  churn_rate: async () => {
    // Users who haven't logged in 30+ days
    const inactive = await db.users.count({
      where: {
        last_seen: { $lt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) }
      }
    });
    
    const total = await db.users.count();
    return (inactive / total) * 100;
  }
};
```

-----

## **ðŸŽ‰ THATâ€™S THE COMPLETE MASTER PROMPT**

-----

## Summary of Whatâ€™s Included:

âœ… **5 Elite AI System Prompts** (Post-session, Pre-training, Technique Query, General, Competition)  
âœ… **Dual-AI Architecture** (GPT-4o + Claude strategic workflow)  
âœ… **Complete Database Schema** (9 tables, fully normalized)  
âœ… **Video Curation & Timestamping System** (YouTube API + GPT-4o analysis)  
âœ… **Multilingual Processing** (Portuguese â†” English)  
âœ… **9 Launch Features** (Fully specified with code examples)  
âœ… **12 API Endpoints** (Complete REST API)  
âœ… **12-Day Implementation Sequence** (Day-by-day build order)  
âœ… **Testing & Deployment Guide** (Unit tests, E2E tests, monitoring)

-----

## **How to Use This Prompt:**

1. **Copy entire document**
1. **Paste into Replit Agent**
1. **Say: â€œBuild this application following the master promptâ€**
1. **Replit Agent will:**

- Create folder structure
- Set up database with Prisma
- Build all API endpoints
- Integrate Claude & GPT-4o
- Implement video curation system
- Build all 9 launch features
- Create frontend UI
- Deploy to production

-----

## **Ready to Build?**

This is **the most comprehensive BJJ app specification ever written**. Every detail designed for excellence.

**Excellence is our pillar. Letâ€™s build the worldâ€™s smartest BJJ coach.**

ðŸ¥‹ **Copy this prompt and paste it into Replit Agent. Letâ€™s ship BJJ OS.**
# **FULL MASTER PROMPT FOR REPLIT AGENT**

```
CRITICAL BUG FOUND: sessionToken cookie never set after phone verification - causing 401 errors

I have the console logs showing exactly what's wrong. The user completes phone verification successfully, but NO cookie is set, causing all subsequent requests to fail with 401 Authentication Required.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

CONSOLE LOG EVIDENCE:

[ONBOARDING] Complete Setup clicked
[ONBOARDING] Form values: â–¸ Object
=== ONBOARDING SUBMISSION DEBUG ===
[ONBOARDING] Form validation passed!
[ONBOARDING] Starting submission with data: â–¸ Object
[DEBUG] document.cookie:
[DEBUG] All cookies available: NONE
[ONBOARDING] Sending payload: â–¸ Object
[DEBUG] Making PATCH request to /api/auth/profile with credentials: include

Failed to load resource: the server responded with a status of 401

=== ONBOARDING ERROR ===
â–¸ [ONBOARDING] Error message: 401: {"error":"Authentication required"}
â–¸ [ONBOARDING] Full error: Error: 401: {"error":"Authentication required"}
â–¸ [DEBUG] 401 ERROR - Authentication failed
â–¸ [DEBUG] This means the sessionToken cookie was not sent or is invalid
â–¸ [DEBUG] Check server logs for cookie status

KEY FINDING: [DEBUG] All cookies available: NONE

This proves the sessionToken cookie was NEVER set after phone verification completed.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ROOT CAUSE:

The phone verification endpoint successfully verifies the user, but FAILS to set the sessionToken httpOnly cookie in the response. This causes all subsequent authenticated requests (onboarding completion, profile updates) to fail with 401 errors.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

THE FIX:

1. FIND THE PHONE VERIFICATION ENDPOINT

Location: Likely at /api/auth/verify or /api/auth/login or similar

Current (broken) code probably looks like:
```python
@app.route('/api/auth/verify', methods=['POST'])
def verify_phone():
    phone = request.json.get('phone')
    code = request.json.get('code')
    
    # Verify code against Twilio or whitelist
    if verification_successful:
        user = get_or_create_user(phone)
        return jsonify({'success': True, 'user': user})  # â† MISSING COOKIE!
```

Fixed code MUST look like:

```python
@app.route('/api/auth/verify', methods=['POST'])
def verify_phone():
    phone = request.json.get('phone')
    code = request.json.get('code')  # or auto-verify for whitelist
    
    # Verify code or check whitelist
    if verification_successful:
        user = get_or_create_user(phone)
        
        # Generate session token
        session_token = create_session_token(user.id)  # Use JWT or similar
        
        # CREATE RESPONSE OBJECT
        response = jsonify({
            'success': True,
            'user': {
                'id': user.id,
                'phone': user.phone,
                'hasCompletedOnboarding': user.has_completed_onboarding
            }
        })
        
        # SET THE COOKIE - THIS IS THE CRITICAL MISSING PIECE
        response.set_cookie(
            'sessionToken',           # Cookie name
            session_token,             # Token value
            httponly=True,             # Prevents JavaScript access (security)
            secure=True,               # HTTPS only (required for production)
            samesite='None',           # Allows cross-origin cookies (required)
            max_age=30*24*60*60,       # 30 days in seconds
            path='/',                  # Available on all paths
            domain='.bjjos.app'        # Works on bjjos.app and subdomains
        )
        
        # DEBUG LOGGING
        print('[AUTH] Phone verified successfully:', phone)
        print('[AUTH] Session token created:', session_token[:20] + '...')
        print('[AUTH] Cookie set with name: sessionToken')
        print('[AUTH] Cookie attributes: httponly=True, secure=True, samesite=None')
        
        return response
```

1. CREATE SESSION TOKEN FUNCTION (if it doesnâ€™t exist)

```python
import jwt
import datetime
import os

def create_session_token(user_id):
    """Generate a JWT session token for the user"""
    
    secret_key = os.environ.get('JWT_SECRET_KEY') or 'your-secret-key-here'
    
    payload = {
        'user_id': user_id,
        'exp': datetime.datetime.utcnow() + datetime.timedelta(days=30),
        'iat': datetime.datetime.utcnow()
    }
    
    token = jwt.encode(payload, secret_key, algorithm='HS256')
    return token
```

1. VERIFY COOKIE MIDDLEWARE

Make sure you have middleware that reads the cookie on subsequent requests:

```python
from functools import wraps

def require_auth(f):
    """Decorator to require authentication for endpoints"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        # Get token from cookie
        session_token = request.cookies.get('sessionToken')
        
        if not session_token:
            print('[AUTH] No sessionToken cookie found')
            print('[AUTH] Available cookies:', request.cookies)
            return jsonify({'error': 'Authentication required'}), 401
        
        try:
            # Verify token
            secret_key = os.environ.get('JWT_SECRET_KEY') or 'your-secret-key-here'
            payload = jwt.decode(session_token, secret_key, algorithms=['HS256'])
            user_id = payload['user_id']
            
            # Get user from database
            user = User.query.get(user_id)
            if not user:
                print('[AUTH] User not found for ID:', user_id)
                return jsonify({'error': 'Authentication required'}), 401
            
            # Attach user to request context
            request.current_user = user
            
            print('[AUTH] Authenticated user:', user.id)
            return f(*args, **kwargs)
            
        except jwt.ExpiredSignatureError:
            print('[AUTH] Token expired')
            return jsonify({'error': 'Session expired'}), 401
        except jwt.InvalidTokenError as e:
            print('[AUTH] Invalid token:', str(e))
            return jsonify({'error': 'Authentication required'}), 401
    
    return decorated_function
```

1. APPLY AUTH DECORATOR TO PROTECTED ENDPOINTS

```python
@app.route('/api/auth/profile', methods=['PATCH'])
@require_auth  # â† This decorator checks for sessionToken cookie
def update_profile():
    user = request.current_user  # Set by @require_auth decorator
    data = request.json
    
    # Update user profile with onboarding data
    user.belt_level = data.get('beltLevel')
    user.training_frequency = data.get('trainingFrequency')
    user.username = data.get('username')
    # ... etc
    
    user.has_completed_onboarding = True
    db.session.commit()
    
    return jsonify({'success': True, 'user': user.to_dict()})
```

1. CHECK CORS CONFIGURATION

Make sure Flask CORS is properly configured to allow credentials:

```python
from flask_cors import CORS

# Apply to your Flask app
CORS(app, 
    supports_credentials=True,  # CRITICAL: Allows cookies
    origins=[
        'https://bjjos.app',
        'https://www.bjjos.app',
        'http://localhost:3000'  # For local development
    ],
    allow_headers=['Content-Type', 'Authorization'],
    methods=['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS']
)
```

1. VERIFY FRONTEND IS SENDING CREDENTIALS

Check that all fetch requests include credentials:

```javascript
// This should already be present based on console logs
fetch('/api/auth/profile', {
    method: 'PATCH',
    credentials: 'include',  // â† Tells browser to send cookies
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(profileData)
})
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

IMPLEMENTATION CHECKLIST:

â–¡ Find phone verification endpoint
â–¡ Add response.set_cookie() to verification endpoint
â–¡ Create create_session_token() function if needed
â–¡ Install PyJWT if not installed: pip install pyjwt
â–¡ Create @require_auth decorator
â–¡ Apply @require_auth to /api/auth/profile and other protected endpoints
â–¡ Verify CORS configuration includes supports_credentials=True
â–¡ Add JWT_SECRET_KEY to environment variables
â–¡ Add debug logging to track cookie creation and validation
â–¡ Deploy changes

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

TESTING INSTRUCTIONS:

After deploying the fix:

1. Clear all cookies for bjjos.app
1. Go to bjjos.app
1. Open DevTools â†’ Console (keep open)
1. Enter phone number and verify
1. IMMEDIATELY check DevTools â†’ Application â†’ Cookies â†’ bjjos.app
1. Confirm sessionToken cookie is present with:

- Name: sessionToken
- HttpOnly: âœ“
- Secure: âœ“
- SameSite: None
- Path: /

1. Continue through onboarding steps
1. Click â€œComplete Setupâ€ on final step
1. Should successfully complete without 401 error
1. Should redirect to chat interface

If sessionToken cookie appears in step 6, the 401 error will be fixed.
If cookie still doesnâ€™t appear, check server logs for cookie-setting errors.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

EXPECTED SERVER LOGS AFTER FIX:

[AUTH] Phone verified successfully: +1XXXXXXXXXX
[AUTH] Session token created: eyJhbGciOiJIUzI1NiIsâ€¦
[AUTH] Cookie set with name: sessionToken
[AUTH] Cookie attributes: httponly=True, secure=True, samesite=None

[Later when submitting onboarding]
[AUTH] Authenticated user: 123

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

COMMON ISSUES TO AVOID:

1. Forgetting secure=True on production (required for HTTPS)
1. Forgetting samesite=â€˜Noneâ€™ (required for cross-origin cookies)
1. Wrong domain (use â€˜.bjjos.appâ€™ to work on all subdomains)
1. Not including supports_credentials=True in CORS
1. Token creation function not working (install PyJWT)
1. Missing JWT_SECRET_KEY environment variable

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

PRIORITY: CRITICAL - BLOCKING ALL USER SIGNUPS

This is the root cause of the 401 error. No users can complete onboarding until the sessionToken cookie is properly set after phone verification.

Implement the fix, deploy, and test immediately.

Once the cookie is working, the 401 error will disappear and users will successfully complete onboarding.

```
---

**Copy and paste this entire prompt into Replit Agent. This gives them everything they need to fix it properly.** ğŸ¯â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹
```
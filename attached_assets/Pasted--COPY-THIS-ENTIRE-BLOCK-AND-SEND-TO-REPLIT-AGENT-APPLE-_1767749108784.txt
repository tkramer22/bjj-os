**COPY THIS ENTIRE BLOCK AND SEND TO REPLIT AGENT:**

```
=== APPLE IN-APP PURCHASE - FRONTEND INTEGRATION ===

The backend for Apple IAP is already built. Now we need to:
1. Update the Product ID to match App Store Connect
2. Install the Capacitor IAP plugin
3. Build the purchase UI for iOS
4. Hide referral code input on iOS

=== PART 1: UPDATE PRODUCT ID ===

Everywhere in the code that references the Apple product ID, change it to:

bjjos_pro_monthlybjjos_pro_monthly

Search for "bjjos_pro_monthly" and replace with "bjjos_pro_monthlybjjos_pro_monthly"

=== PART 2: INSTALL CAPACITOR IAP PLUGIN ===

Run these commands:

npm install cordova-plugin-purchase
npm install @awesome-cordova-plugins/in-app-purchase-2
npx cap sync ios

=== PART 3: CREATE APPLE PURCHASE SERVICE ===

Create file: client/src/services/applePurchase.ts

```typescript
import { Capacitor } from '@capacitor/core';

// Product ID from App Store Connect
const PRODUCT_ID = 'bjjos_pro_monthlybjjos_pro_monthly';

declare global {
  interface Window {
    CdvPurchase: any;
  }
}

export const ApplePurchaseService = {
  isIOS: () => {
    return Capacitor.isNativePlatform() && Capacitor.getPlatform() === 'ios';
  },

  async initialize() {
    if (!this.isIOS()) return;

    // Wait for the plugin to be ready
    await new Promise<void>((resolve) => {
      document.addEventListener('deviceready', () => resolve(), false);
      // If already ready, resolve immediately
      if (window.CdvPurchase) resolve();
    });

    const { store, ProductType, Platform } = window.CdvPurchase;

    // Register the product
    store.register({
      id: PRODUCT_ID,
      type: ProductType.PAID_SUBSCRIPTION,
      platform: Platform.APPLE_APPSTORE,
    });

    // Set up event handlers
    store.when()
      .productUpdated((product: any) => {
        console.log('Product updated:', product);
      })
      .approved((transaction: any) => {
        console.log('Purchase approved:', transaction);
        // Verify with our backend
        this.verifyPurchase(transaction);
      })
      .verified((receipt: any) => {
        console.log('Receipt verified:', receipt);
        receipt.finish();
      })
      .finished((transaction: any) => {
        console.log('Transaction finished:', transaction);
      });

    // Initialize the store
    await store.initialize([Platform.APPLE_APPSTORE]);
    await store.update();
  },

  async getProduct() {
    if (!this.isIOS()) return null;
    
    const { store } = window.CdvPurchase;
    return store.get(PRODUCT_ID);
  },

  async purchase() {
    if (!this.isIOS()) {
      throw new Error('Apple purchase only available on iOS');
    }

    const { store } = window.CdvPurchase;
    const product = store.get(PRODUCT_ID);

    if (!product) {
      throw new Error('Product not found');
    }

    const offer = product.getOffer();
    if (!offer) {
      throw new Error('No offer available');
    }

    // This triggers Apple's payment sheet
    await offer.order();
  },

  async verifyPurchase(transaction: any) {
    try {
      const response = await fetch('/api/subscriptions/apple/verify', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          receiptData: transaction.appStoreReceipt,
          transactionId: transaction.transactionId,
        }),
      });

      const result = await response.json();
      
      if (result.success) {
        // Finish the transaction
        transaction.finish();
        return { success: true };
      } else {
        throw new Error(result.error || 'Verification failed');
      }
    } catch (error) {
      console.error('Verification error:', error);
      throw error;
    }
  },

  async restorePurchases() {
    if (!this.isIOS()) return;
    
    const { store } = window.CdvPurchase;
    await store.restorePurchases();
  }
};
```

=== PART 4: UPDATE SUBSCRIPTION HOOK ===

Update file: client/src/hooks/useSubscription.ts

```typescript
import { useState, useEffect } from 'react';
import { ApplePurchaseService } from '../services/applePurchase';

export const useSubscription = () => {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [product, setProduct] = useState<any>(null);

  const isIOS = ApplePurchaseService.isIOS();
  const isWeb = !isIOS;

  useEffect(() => {
    if (isIOS) {
      ApplePurchaseService.initialize().then(() => {
        ApplePurchaseService.getProduct().then(setProduct);
      });
    }
  }, [isIOS]);

  const subscribe = async () => {
    setIsLoading(true);
    setError(null);

    try {
      if (isIOS) {
        await ApplePurchaseService.purchase();
        return { success: true };
      } else {
        // Redirect to Stripe checkout for web users
        window.location.href = '/api/stripe/create-checkout-session';
        return { success: true };
      }
    } catch (err: any) {
      setError(err.message || 'Purchase failed');
      return { success: false, error: err.message };
    } finally {
      setIsLoading(false);
    }
  };

  const restorePurchases = async () => {
    if (!isIOS) return;
    
    setIsLoading(true);
    try {
      await ApplePurchaseService.restorePurchases();
    } catch (err: any) {
      setError(err.message);
    } finally {
      setIsLoading(false);
    }
  };

  return {
    subscribe,
    restorePurchases,
    isIOS,
    isWeb,
    isLoading,
    error,
    product,
    price: product?.pricing?.price || '$19.99'
  };
};
```

=== PART 5: CREATE SUBSCRIBE BUTTON COMPONENT ===

Create file: client/src/components/SubscribeButton.tsx

```typescript
import React from 'react';
import { useSubscription } from '../hooks/useSubscription';

interface SubscribeButtonProps {
  className?: string;
}

export const SubscribeButton: React.FC<SubscribeButtonProps> = ({ className }) => {
  const { subscribe, isLoading, error, price, isIOS } = useSubscription();

  const handleSubscribe = async () => {
    const result = await subscribe();
    if (result.success && !isIOS) {
      // Web users are redirected to Stripe
      return;
    }
    if (result.success && isIOS) {
      // iOS purchase completed - reload to update UI
      window.location.reload();
    }
  };

  return (
    <div>
      <button
        onClick={handleSubscribe}
        disabled={isLoading}
        className={className || 'bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold'}
      >
        {isLoading ? 'Processing...' : `Subscribe - ${price}/month`}
      </button>
      {error && <p className="text-red-500 mt-2">{error}</p>}
    </div>
  );
};
```

=== PART 6: CREATE RESTORE PURCHASES BUTTON (iOS only) ===

Create file: client/src/components/RestorePurchases.tsx

```typescript
import React from 'react';
import { useSubscription } from '../hooks/useSubscription';

export const RestorePurchases: React.FC = () => {
  const { restorePurchases, isLoading, isIOS } = useSubscription();

  // Only show on iOS
  if (!isIOS) return null;

  return (
    <button
      onClick={restorePurchases}
      disabled={isLoading}
      className="text-blue-600 underline text-sm"
    >
      {isLoading ? 'Restoring...' : 'Restore Purchases'}
    </button>
  );
};
```

=== PART 7: HIDE REFERRAL CODE ON iOS ===

In any signup or checkout component that has a referral code input, wrap it like this:

```typescript
import { Capacitor } from '@capacitor/core';

// Inside the component:
const isIOS = Capacitor.isNativePlatform() && Capacitor.getPlatform() === 'ios';

// In the JSX, wrap referral code input:
{!isIOS && (
  <div className="referral-code-section">
    <label>Referral Code (optional)</label>
    <input
      type="text"
      value={referralCode}
      onChange={(e) => setReferralCode(e.target.value)}
      placeholder="Enter referral code"
    />
  </div>
)}
```

Find all places where referral code input exists and add this conditional.

=== PART 8: UPDATE PAYWALL/UPGRADE SCREEN ===

Update any paywall or upgrade screen to use the new components:

```typescript
import React from 'react';
import { SubscribeButton } from '../components/SubscribeButton';
import { RestorePurchases } from '../components/RestorePurchases';
import { useSubscription } from '../hooks/useSubscription';
import { Capacitor } from '@capacitor/core';

export const UpgradeScreen: React.FC = () => {
  const { isIOS } = useSubscription();
  const showReferralCode = !isIOS;

  return (
    <div className="upgrade-screen p-6 max-w-md mx-auto">
      <h1 className="text-2xl font-bold mb-4">Upgrade to BJJ OS Pro</h1>
      
      <ul className="mb-6 space-y-2">
        <li>✓ Unlimited AI coaching sessions</li>
        <li>✓ Complete technique library</li>
        <li>✓ Training history & analytics</li>
        <li>✓ Perfect memory of your journey</li>
      </ul>

      {showReferralCode && (
        <div className="mb-4">
          <label className="block text-sm mb-1">Referral Code (optional)</label>
          <input
            type="text"
            className="w-full border rounded px-3 py-2"
            placeholder="Enter code for 7-day free trial"
          />
        </div>
      )}

      <SubscribeButton className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold" />

      <div className="mt-4 text-center">
        <RestorePurchases />
      </div>

      <p className="text-xs text-gray-500 mt-4 text-center">
        {isIOS 
          ? 'Payment will be charged to your Apple ID account. Subscription automatically renews unless canceled at least 24 hours before the end of the current period.'
          : 'Cancel anytime. 7-day free trial with referral code.'}
      </p>
    </div>
  );
};
```

=== PART 9: ADD CAPACITOR CONFIG ===

Make sure capacitor.config.ts includes:

```typescript
import { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
  appId: 'app.bjjos.mobile',
  appName: 'BJJ OS',
  webDir: 'dist',
  server: {
    androidScheme: 'https'
  },
  plugins: {
    // Add any plugin-specific config here
  }
};

export default config;
```

=== PART 10: REBUILD iOS APP ===

After all changes, run:

npm run build
npx cap sync ios

Then open Xcode:

npx cap open ios

In Xcode:

1. Select your target
1. Go to “Signing & Capabilities”
1. Add capability: “In-App Purchase” (click + Capability, search for In-App Purchase)
1. Build and run to test

=== SUMMARY ===

This prompt:

1. ✅ Updates Product ID to bjjos_pro_monthlybjjos_pro_monthly
1. ✅ Installs Capacitor IAP plugin
1. ✅ Creates Apple purchase service
1. ✅ Creates useSubscription hook (detects iOS vs web)
1. ✅ Creates SubscribeButton component
1. ✅ Creates RestorePurchases component (iOS only)
1. ✅ Hides referral code on iOS
1. ✅ Creates upgrade screen with proper messaging
1. ✅ Configures Capacitor

After Replit builds this, you need to:

1. Rebuild in Xcode
1. Add In-App Purchase capability in Xcode
1. Test on device or TestFlight

```
---

Send this to Replit Agent. Once it's done building, come back and we'll finish the App Store Connect setup (getting the Shared Secret and setting up the webhook URL).​​​​​​​​​​​​​​​​
```